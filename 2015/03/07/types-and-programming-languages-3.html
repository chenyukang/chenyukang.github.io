<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="All about coding and writing">
  <meta name="keyword" content="Programming, Programming Languages, Algorithms, Tools">
  <meta property="og:site_name" content="程序员的喵">
  <meta property="og:title" content="Types and Programming Languages (3) | 程序员的喵" />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="" />
  <meta property="og:description" content="" />
  <meta property="og:image" content=" http://catcoding.me/css/images/logo.png " />
  <link rel="alternate" type="application/rss+xml" title="程序员的喵; Feed" href="https://catcoding.me/atom.xml" />

  
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/gitment.css">

  
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/fonts.css">

  
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/code.css">

  
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/prism.css">

  
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/font-awesome.min.css">

  
<script src="/js/qrious.js"></script>
<script src="/js/gitment.js"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/geopattern.min.js"></script>
<script src="/js/nprogress.min.js"></script>

  
  
  <link rel="shortcut icon" href="/css/images/favicon.ico">
  
  <title>
    
    Types and Programming Languages (3) |
    程序员的喵
    
  </title>

  <div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src="/css/images/logo.png" width='400px' height='400px' />
  </div>

  
  


  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-77282254-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'UA-77282254-1');
  </script>

<meta name="generator" content="Hexo 5.4.2"></head>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>程序员的喵</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/links/" class="item-link">Links</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      

        <li class="list-item" style="margin: 0">
       <a class="icon-small" href="/search">
        <span class="fa-stack fa-lg">
          <i class="fa fa-search fa-stack-1x fa-inverse" style="color:#8ccb8c"></i>
        </span>
       </a>
      </li>

       <li class="list-item" style="margin-left: 3px">
        <a class="icon-small" href="/atom.xml">
         <span class="fa-stack fa-lg">
           <i class="fa fa-rss fa-inverse" style="color:orange"></i>
         </span>
        </a>
       </li>
    </ul>
    
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/links/" class="menu-link">Links</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>Types and Programming Languages (3)</h2>
  <p class="post-date">2015-03-07</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>


<main class="app-body flex-box">


  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><h2 id="Subtyping"><a href="#Subtyping" class="headerlink" title="Subtyping"></a>Subtyping</h2><p>subtyping 解决的问题是多态，OO 的一个基本要素。</p>
<blockquote>
<p>we say that S is a subtype of T, written S &lt;: T, to mean that any term of type S can safely be used in a context where a term of type T is expected. This view of subtyping is often called the principle of safe substitution.</p>
</blockquote>
<p>这章只是以 record 来作为例子说明，直白的所一个类型 S 是另外一个类型的 T 的子类型，意思是任何使用 T 的 context，我们可以安全的使用 S。对于 record 类型来说，field 数量多的是 field 数量少的子类型，因为这样任何从 T 要取得的 field 都可以从子类型里面取到。</p>
<p>对于函数类型来说，如果<code>S1-&gt;S2</code>, <code>T1-&gt;T2</code>, S1 是 T1 的子类型，S2 是 T2 的子类行，那么<code>S1-&gt;S2</code>是<code>T1-&gt;T2</code>的子类型。</p>
<p>引入 Top 类型，是所有类型的父类，对应很多编程语言里面的 Object(OOP 里面常见的伎俩)，Go 里面我就这样定义：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Object <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>引入 Bottom 类型似乎就没什么大用处了，还增加了 typecheker 的复杂度。</p>
<h2 id="Ascription-and-Casting"><a href="#Ascription-and-Casting" class="headerlink" title="Ascription and Casting"></a>Ascription and Casting</h2><p>类型的强制转换，分为 up-cast 和 down-cast。up-cast 对于类型检查来说要简单一些，比如类型<code>Animal -&gt; Dog</code>, <code>Animal -&gt; Cat</code>，由<code>Cat</code>到<code>Animal</code>的类型转换为 up-cast。在很多语言里面是当做一种抽象方法。</p>
<p>down-cast 要复杂一些，而且也可能会导致类型系统的不安全，比如：</p>
<pre class="line-numbers language-ocaml" data-language="ocaml"><code class="language-ocaml">f <span class="token operator">=</span> λ<span class="token punctuation">(</span>x<span class="token punctuation">:</span>Top<span class="token punctuation">)</span> <span class="token punctuation">(</span>x <span class="token keyword">as</span> <span class="token punctuation">&#123;</span>a<span class="token punctuation">:</span>Nat<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>a<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个函数接收任何类型的参数，但是隐含一个假设，必须是一个有成员变量为数字类型的 a，如果传递一个错误的参数 typechecker 也不报错，但运行的时候就会有错误了。所以含有 down-cast 的类型系统应该遵循： <code>trust, but verify</code>，编译的时候不报错，但是留着运行的时候检查。为了避免 down-cast 引起的复杂问题，ML 等语言选择的是<code>down-cast with type tags</code>。</p>
<p><code>channels</code>:</p>
<blockquote>
<p>The key observation is that, from the point of view of typing, a communication channel behaves exactly like a reference cell: it can be used for both reading and writing, and, since it is difficult to determine statically which reads correspond to which writes, the only simple way to ensure type safety is to require that all the values passed along the channel must belong to the same type.</p>
</blockquote>
<p>subtyping 的引入导致分支多的情况下类型检查麻烦，因此引入了 Join 和 Meet 的概念，实现可参考代码里面的：</p>
<pre class="line-numbers language-ocaml" data-language="ocaml"><code class="language-ocaml"><span class="token keyword">let</span> <span class="token keyword">rec</span> join ctx tyS tyT <span class="token operator">=</span>
  <span class="token keyword">if</span> subtype ctx tyS tyT <span class="token keyword">then</span> tyT <span class="token keyword">else</span>
  <span class="token keyword">if</span> subtype ctx tyT tyS <span class="token keyword">then</span> tyS <span class="token keyword">else</span>
  <span class="token keyword">let</span> tyS <span class="token operator">=</span> simplifyty ctx tyS <span class="token keyword">in</span>
  <span class="token keyword">let</span> tyT <span class="token operator">=</span> simplifyty ctx tyT <span class="token keyword">in</span>
  <span class="token keyword">match</span> <span class="token punctuation">(</span>tyS<span class="token punctuation">,</span>tyT<span class="token punctuation">)</span> <span class="token keyword">with</span>
    <span class="token punctuation">(</span>TyArr<span class="token punctuation">(</span>tyS1<span class="token punctuation">,</span>tyS2<span class="token punctuation">)</span><span class="token punctuation">,</span>TyArr<span class="token punctuation">(</span>tyT1<span class="token punctuation">,</span>tyT2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-></span>
      TyArr<span class="token punctuation">(</span>meet ctx  tyS1 tyT1<span class="token punctuation">,</span> join ctx tyS2 tyT2<span class="token punctuation">)</span>
  <span class="token operator">|</span> <span class="token punctuation">_</span> <span class="token operator">-></span>
      TyTop

<span class="token operator">and</span> meet ctx tyS tyT <span class="token operator">=</span>
  <span class="token operator">..</span><span class="token operator">..</span><span class="token operator">..</span><span class="token punctuation">.</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Case-Study-Imperative-Objects"><a href="#Case-Study-Imperative-Objects" class="headerlink" title="Case Study: Imperative Objects"></a>Case Study: Imperative Objects</h2><p>不考虑实现效率和语法简洁的条件下，目前为止学到的语言特性已经足够来模拟实现 OOP。最简单的例子就是一个 counter:</p>
<pre class="line-numbers language-ocaml" data-language="ocaml"><code class="language-ocaml">c <span class="token operator">=</span> <span class="token keyword">let</span> x <span class="token operator">=</span> ref <span class="token number">1</span> <span class="token keyword">in</span>
    <span class="token punctuation">&#123;</span>get <span class="token operator">=</span> λ<span class="token punctuation">_</span><span class="token punctuation">:</span>Unit<span class="token punctuation">.</span> <span class="token operator">!</span>x<span class="token punctuation">,</span>
    inc <span class="token operator">=</span> λ<span class="token punctuation">_</span><span class="token punctuation">:</span>Unit<span class="token punctuation">.</span> x<span class="token operator">:=</span>succ<span class="token punctuation">(</span><span class="token operator">!</span>x<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>OOP 作为一种抽象手段，可以让通过接口来隐藏实现，客户端的代码只通过同一个接口才操作各种子类的对象。这里的例子一个子类只是比父类多接口而已。</p>
<pre class="line-numbers language-ocaml" data-language="ocaml"><code class="language-ocaml">newResetCounter <span class="token operator">=</span>
    λ<span class="token punctuation">_</span><span class="token punctuation">:</span>Unit<span class="token punctuation">.</span> <span class="token keyword">let</span> x <span class="token operator">=</span> ref <span class="token number">1</span> <span class="token keyword">in</span>
    <span class="token punctuation">&#123;</span>get <span class="token operator">=</span> λ<span class="token punctuation">_</span><span class="token punctuation">:</span>Unit<span class="token punctuation">.</span> <span class="token operator">!</span>x<span class="token punctuation">,</span>
    inc <span class="token operator">=</span> λ<span class="token punctuation">_</span><span class="token punctuation">:</span>Unit<span class="token punctuation">.</span> x<span class="token operator">:=</span>succ<span class="token punctuation">(</span><span class="token operator">!</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> reset <span class="token operator">=</span> λ<span class="token punctuation">_</span><span class="token punctuation">:</span>Unit<span class="token punctuation">.</span> x<span class="token operator">:=</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>self 的简单是现实需要动态找到对应的 method，更高效的实现当然是对象创建好后 method table 建好。</p>
</section>

    <p></p>
    <!-- 二维码 START -->
    
        <div class="qrcode">
            <img src="/images/wechat-qr-code.jpg" height="160" width="160">
            <figcaption>公号同步更新，欢迎关注👻</figcaption>
      </div>
    

    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#Programming" >
    <span class="tag-code">Programming</span>
  </a>

  <a href="/tags#OCaml" >
    <span class="tag-code">OCaml</span>
  </a>

  <a href="/tags#PL" >
    <span class="tag-code">PL</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2015/03/07/types-and-programming-languages-2.html">
        <span class="nav-arrow">← </span>
        
          Types and Programming ...
        
      </a>
    
    
      <a class="nav-right" href="/2015/03/01/types-and-programming-languages.html">
        
          Types and Programming  ...
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->

    <!-- 二维码 END -->
    
      <!-- No Comment -->
    



    <script src="https://utteranc.es/client.js"
      repo="chenyukang/chenyukang.github.io"
      issue-term="pathname"
      theme="github-light"
      crossorigin="anonymous"
      async>
    </script>


  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title"></strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Subtyping"><span class="toc-nav-text">Subtyping</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Ascription-and-Casting"><span class="toc-nav-text">Ascription and Casting</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Case-Study-Imperative-Objects"><span class="toc-nav-text">Case Study: Imperative Objects</span></a></li></ol>
    
  </div>
</aside>

  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://catcoding.me/2015/03/07/types-and-programming-languages-3.html';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

     // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW * 3 / 4}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer" id="footer">
    <p class="copyright">
        &copy;
        2023 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a> with <a target="_blank" rel="noopener" href="https://github.com/yanm1ng/hexo-theme-vexo">Vexo</a>
    </p>
</footer>

<script>
    function async(u, c) {
        var d = document,
            t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) {
            o.addEventListener('load', function(e) {
                c(null, e);
            }, false);
        }
        s.parentNode.insertBefore(o, s);
    }
</script>
<script>
    async("//catcoding.me/js/fastclick.min.js", function() {
        FastClick.attach(document.body);
    })
</script>


<script src="/js/script.js"></script>

  </body>
</html>