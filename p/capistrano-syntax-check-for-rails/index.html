<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="All about coding and writing">
  <meta name="keyword" content="Programming, Programming Languages, Algorithms, Tools">
  <meta property="og:site_name" content="CatCoding">
  <meta property="og:title" content="Add syntax check for Capistrano | CatCoding" />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="" />
  <meta property="og:description" content="" />
  <meta property="og:image" content=" http://catcoding.me/css/images/logo.png " />
  <link rel="alternate" type="application/rss+xml" title="CatCoding; Feed" href="https://catcoding.me/atom.xml" />

  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/gitment.css">
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/fonts.css">
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/code.css">
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/prism.css">
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/font-awesome.min.css">
  <script src="/js/qrious.js"></script>
<script src="/js/gitment.js"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/geopattern.min.js"></script>
<script src="/js/nprogress.min.js"></script>

  
  <link rel="icon" href="/css/images/favicon.ico">
  
  <title>
    
    Add syntax check for Capistrano |
    CatCoding
    
  </title>

  <div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src="/css/images/logo.png" width='400px' height='400px' />
  </div>

  
  



<script defer src="https://cloud.umami.is/script.js" data-website-id="9767b9c8-6554-4673-af8c-2d22e00617aa"></script>
</head>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>CatCoding</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/ideas/" class="item-link">Ideas</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/links/" class="item-link">Links</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      

        <li class="list-item" style="margin: 0">
       <a class="icon-small" href="/search">
        <span class="fa-stack fa-lg">
          <i class="fa fa-search fa-stack-1x fa-inverse" style="color:#8ccb8c"></i>
        </span>
       </a>
      </li>

       <li class="list-item" style="margin-left: 3px">
        <a class="icon-small" href="/atom.xml">
         <span class="fa-stack fa-lg">
           <i class="fa fa-rss fa-inverse" style="color:orange"></i>
         </span>
        </a>
       </li>
    </ul>
    
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/ideas/" class="menu-link">Ideas</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/links/" class="menu-link">Links</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>Add syntax check for Capistrano</h2>
  <p class="post-date">2016-07-22</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>


<main class="app-body flex-box" style="max-width: 850px" >


  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p>In an normal release, Rails app‚Äôs unit testing will avoid most errors. But for the urgent code publishing, we have got several time of typo error. Code syntax error may cause server crash for a little while(Passenger web server and we using <code>./tmp/restart.txt</code> to restart). We use Capistrano to publish code, so I plan to add a syntax checking before publishing code.
The method is writing a task to bundle exec rails runner, this will report most ruby syntax error(except the undef variables in some functions, runner will load .rb files).</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token ruby">namespace <span class="token constant symbol ruby"><span class="token punctuation definition constant ruby">:</span>app</span> <span class="token keyword start-block ruby">do</span>
  desc <span class="token string double ruby"><span class="token punctuation definition string begin ruby">&quot;</span>check all the ruby code<span class="token punctuation definition string end ruby">&quot;</span></span>
  task <span class="token constant symbol ruby"><span class="token punctuation definition constant ruby">:</span>check</span> <span class="token punctuation separator key-value ruby">=&gt;</span> <span class="token constant symbol ruby"><span class="token punctuation definition constant ruby">:</span>environment</span> <span class="token keyword start-block ruby">do</span>
    res <span class="token operator assignment ruby">=</span> <span class="token string interpolated ruby"><span class="token punctuation definition string begin ruby">`</span>RAILS_ENV=<span class="token ruby embedded source"><span class="token punctuation section embedded ruby">#{</span><span class="token class-name ruby">Rails</span><span class="token punctuation accessor ruby">.</span>env<span class="token punctuation section embedded ruby">}</span></span>  bundle exec rails runner &quot;&quot; 2&gt;&amp;1<span class="token punctuation definition string end ruby">`</span></span>
    <span class="token keyword special-method ruby">raise</span> res <span class="token keyword ruby">if</span> res<span class="token punctuation accessor ruby">.</span>size <span class="token operator comparison ruby">&gt;</span> <span class="token number ruby">0</span>
  <span class="token keyword ruby">end</span>
<span class="token keyword ruby">end</span>
</span></code></pre>
<p>then add this in the deploy.rb (Capistrano 3.1):</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token ruby">namespace <span class="token constant symbol ruby"><span class="token punctuation definition constant ruby">:</span>deploy</span> <span class="token keyword start-block ruby">do</span>

  task <span class="token constant symbol ruby"><span class="token punctuation definition constant ruby">:</span>run_code_check</span> <span class="token keyword start-block ruby">do</span>
    on roles<span class="token punctuation definition group begin ruby">(</span><span class="token constant symbol ruby"><span class="token punctuation definition constant ruby">:</span>all</span><span class="token punctuation definition group end ruby">)</span> <span class="token keyword start-block ruby">do</span>
      within release_path <span class="token keyword start-block ruby">do</span>
        with <span class="token constant symbol ruby">rails_env<span class="token punctuation definition constant ruby">:</span></span> fetch<span class="token punctuation definition group begin ruby">(</span><span class="token constant symbol ruby"><span class="token punctuation definition constant ruby">:</span>rails_env</span><span class="token punctuation definition group end ruby">)</span> <span class="token keyword start-block ruby">do</span>
          execute <span class="token constant symbol ruby"><span class="token punctuation definition constant ruby">:</span>rake</span><span class="token punctuation separator ruby">,</span> <span class="token string single ruby"><span class="token punctuation definition string begin ruby">&#39;</span>app:check<span class="token punctuation definition string end ruby">&#39;</span></span>
        <span class="token keyword ruby">end</span>
      <span class="token keyword ruby">end</span>
    <span class="token keyword ruby">end</span>
  <span class="token keyword ruby">end</span>

  before <span class="token string double ruby"><span class="token punctuation definition string begin ruby">&quot;</span>deploy:updated<span class="token punctuation definition string end ruby">&quot;</span></span><span class="token punctuation separator ruby">,</span> <span class="token string double ruby"><span class="token punctuation definition string begin ruby">&quot;</span>deploy:run_code_check<span class="token punctuation definition string end ruby">&quot;</span></span>
<span class="token keyword ruby">end</span>
</span></code></pre>
<p>This is not a tricky part, but please pay attention to the line:</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token ruby">res <span class="token operator assignment ruby">=</span> <span class="token string interpolated ruby"><span class="token punctuation definition string begin ruby">`</span>RAILS_ENV=<span class="token ruby embedded source"><span class="token punctuation section embedded ruby">#{</span><span class="token class-name ruby">Rails</span><span class="token punctuation accessor ruby">.</span>env<span class="token punctuation section embedded ruby">}</span></span>  bundle exec rails runner &quot;&quot; 2&gt;&amp;1<span class="token punctuation definition string end ruby">`</span></span>
</span></code></pre>
<p>This line of code cost me some time, I forget the <code>2&gt;&amp;1</code>. so <code>res</code> will just got the stdout, not the stderr output, which causes the exception is not raised, and Capistrano flow is not stopped.</p>
</section>

    <p></p>

  
    <!-- ‰∫åÁª¥Á†Å START -->
    
        <div class="qrcode">
            <img src="/images/wechat-qr-code.jpg" height="160" width="160">
            <figcaption>ÂÖ¨Âè∑ÂêåÊ≠•Êõ¥Êñ∞ÔºåÊ¨¢ËøéÂÖ≥Ê≥®üëª</figcaption>
      </div>
    

    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#" >
    <span class="tag-code"></span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/p/dao-yu-ju/">
        <span class="nav-arrow">‚Üê </span>
        
          Ëèä‰∏éÂàÄ
        
      </a>
    
    
      <a class="nav-right" href="/p/fun-on-hackerrank/">
        
          Âà∑Âà∑ÁÆóÊ≥ïÂíå OJ
        
        <span class="nav-arrow"> ‚Üí</span>
      </a>
    
  </div>

    <!-- NAV END -->

    <!-- ‰∫åÁª¥Á†Å END -->
    
      <!-- No Comment -->
    

    <script src="https://utteranc.es/client.js"
      repo="chenyukang/chenyukang.github.io"
      issue-term="pathname"
      theme="github-light"
      crossorigin="anonymous"
      async>
    </script>


  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://catcoding.me//p/capistrano-syntax-check-for-rails/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

     // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW * 3 / 4}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer" id="footer">
    <p class="copyright">
        &copy;
        2026 | Proudly powered by <a href="https://github.com/chenyukang/hexo-rs" target="_blank">hexo-rs</a> with <a href="https://github.com/yanm1ng/hexo-theme-vexo">Vexo</a>
    </p>
</footer>

<script>
    function async(u, c) {
        var d = document,
            t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) {
            o.addEventListener('load', function(e) {
                c(null, e);
            }, false);
        }
        s.parentNode.insertBefore(o, s);
    }
</script>
<script>
    async("//catcoding.me/js/fastclick.min.js", function() {
        FastClick.attach(document.body);
    })
</script>

<script src="/js/script.js"></script>
  </body>
</html>