<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="All about coding and writing">
  <meta name="keyword" content="Programming, Programming Languages, Algorithms, Tools">
  <meta property="og:site_name" content="ç¨‹åºå‘˜çš„å–µ">
  <meta property="og:title" content="Rust ç¼–è¯‘å™¨æºç æ¦‚è¦ | ç¨‹åºå‘˜çš„å–µ" />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="" />
  <meta property="og:description" content="" />
  <meta property="og:image" content=" http://catcoding.me/css/images/logo.png " />
  <link rel="alternate" type="application/rss+xml" title="ç¨‹åºå‘˜çš„å–µ; Feed" href="https://catcoding.me/atom.xml" />

  
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/gitment.css">

  
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/fonts.css">

  
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/code.css">

  
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/prism.css">

  
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/font-awesome.min.css">

  
<script src="/js/qrious.js"></script>
<script src="/js/gitment.js"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/geopattern.min.js"></script>
<script src="/js/nprogress.min.js"></script>

  
  
  <link rel="shortcut icon" href="/css/images/favicon.ico">
  
  <title>
    
    Rust ç¼–è¯‘å™¨æºç æ¦‚è¦ |
    ç¨‹åºå‘˜çš„å–µ
    
  </title>

  <div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src="/css/images/logo.png" width='400px' height='400px' />
  </div>

  
  


  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-77282254-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'UA-77282254-1');
  </script>

<meta name="generator" content="Hexo 5.4.2"></head>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>ç¨‹åºå‘˜çš„å–µ</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/links/" class="item-link">Links</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      

        <li class="list-item" style="margin: 0">
       <a class="icon-small" href="/search">
        <span class="fa-stack fa-lg">
          <i class="fa fa-search fa-stack-1x fa-inverse" style="color:#8ccb8c"></i>
        </span>
       </a>
      </li>

       <li class="list-item" style="margin-left: 3px">
        <a class="icon-small" href="/atom.xml">
         <span class="fa-stack fa-lg">
           <i class="fa fa-rss fa-inverse" style="color:orange"></i>
         </span>
        </a>
       </li>
    </ul>
    
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/links/" class="menu-link">Links</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>Rust ç¼–è¯‘å™¨æºç æ¦‚è¦</h2>
  <p class="post-date">2023-03-13</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>


<main class="app-body flex-box">


  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p>ä¸€ä¸ª Rust ç¨‹åºæ˜¯å¦‚ä½•ä»æºæ–‡ä»¶ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶çš„ï¼Ÿ</p>
<p>å¦‚æœä»å¤´å¼€å§‹çœ‹ rustc çš„æºç ä¼šæ— ä»ä¸‹æ‰‹ï¼Œæˆ‘ä¹‹å‰é€šè¿‡è§£å†³ issue å»è¯»è¿‡éƒ¨åˆ†æ¨¡å—çš„æºç ï¼Œå°±æ˜¯ bottom-up çš„æ–¹å¼ï¼Œä½†æˆ‘è¿˜æœªä»æ•´ä½“ä¸Šç†è§£ rustc çš„æºç ç»“æ„ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯æˆ‘åœ¨é‡çœ‹ <a target="_blank" rel="noopener" href="https://rustc-dev-guide.rust-lang.org/getting-started.html">Rust Compiler Development Guide</a> çš„ä¸€äº›éšæ‰‹è®°å½•ï¼Œè¿˜æœ‰äº›è‡ªå·±çš„åŠ¨æ‰‹å®éªŒï¼Œæ—¨åœ¨å˜æ¸…ç¼–è¯‘å™¨çš„å¤§è‡´è„‰ç»œï¼Œç†è§£æ¯ä¸ªé˜¶æ®µåšäº†äº›ä»€ä¹ˆï¼Œå¦‚æœä½ æƒ³çœ‹æ›´ä¸ºå®Œæ•´çš„æ–‡æ¡£è¯·å‚è€ƒå®˜æ–¹çš„æ‰‹å†Œã€‚</p>
<p>Rust ç¼–è¯‘å™¨åˆ†ä¸ºè¿™å‡ ä¸ªä¸»è¦çš„é˜¶æ®µï¼Œå›é¡¾æˆ‘ç›®å‰åšçš„å·¥ä½œå¤§å¤šé›†ä¸­åœ¨ <code>MIR</code> ä¹‹å‰ï¼Œåˆ†é˜¶æ®µä»å‰åˆ°åæ¥è§¦å¾—è¶Šå°‘ ğŸ˜Š</p>
<h2 id="æ•´ä½“æ¶æ„"><a href="#æ•´ä½“æ¶æ„" class="headerlink" title="æ•´ä½“æ¶æ„"></a>æ•´ä½“æ¶æ„</h2><p>ç¼–è¯‘å™¨æ˜¯å…¸å‹çš„è¾“å…¥è¾“å‡ºç³»ç»Ÿï¼Œæ¯ä¸ªé˜¶æ®µéƒ½æœ‰å¯¹åº”çš„å…¥å’Œå‡ºã€‚æˆ‘ä»¬ç»å¸¸å¯ä»¥çœ‹åˆ° <code>lowering</code> è¿™ä¸ªæœ¯è¯­ï¼Œè¿™ä¸ª <code>lowering</code> çš„å¯¹è±¡å¯ä»¥æ˜¯æºç¨‹åºã€ASTã€IRï¼Œä¸æ–­åœ°æŠŠç¨‹åºä¸­çš„æŠ½è±¡ç”±é«˜å˜ä½çš„è¿‡ç¨‹ï¼Œåˆ° <code>MIR</code> å°±å·²ç»æ˜¯ç±»ä¼¼ <code>LLVM IR</code>  è¿™ä¸ªçº§åˆ«äº†ã€‚</p>
<p><img src="/images/ob_pasted-image-20230303200344.png" alt=""></p>
<p><strong>Lexing</strong>: æŠŠæºç¨‹åºè§£æä¸º token æµã€‚</p>
<p><strong>Parsing</strong>: æŠŠ token æµè½¬æ¢ä¸º ASTï¼ˆAbstract Syntax Treeï¼‰ï¼Œè¿™æœŸé—´å¾ˆåšå®æ‰©å±•ã€AST éªŒè¯ã€åç§°è§£æå’Œæ—©æœŸ lintingã€‚</p>
<p><strong>HIR lowering</strong>: å°† AST è½¬æ¢ä¸ºé«˜çº§ä¸­é—´è¡¨ç¤º HIRï¼ˆHigh-level IRï¼‰ï¼Œè¿™æ˜¯ä¸€ç§å¯¹ç¼–è¯‘å™¨æ›´å‹å¥½çš„ AST è¡¨ç¤ºï¼Œå…¶ä¸­ä¹Ÿæ¶‰åŠå¾ˆå¤šè¯¸å¦‚å¾ªç¯å’Œ <code>async fn</code> ä¹‹ç±»çš„è„±ç³–ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨ HIR è¿›è¡Œç±»å‹æ¨æ–­ï¼ˆtype inferenceï¼‰ã€ç‰¹å¾æ±‚è§£ï¼ˆtrait solvingï¼‰å’Œç±»å‹æ£€æŸ¥ï¼ˆtype checkingï¼‰ã€‚</p>
<p><strong>MIR lowering</strong>: å°† HIR è½¬æ¢åˆ° MIRï¼ˆMiddle-level IRï¼‰ï¼Œç”¨äºå€Ÿç”¨æ£€æŸ¥å’Œå…¶ä»–é‡è¦çš„åŸºäºæ•°æ®æµçš„æ£€æŸ¥ï¼Œä¾‹å¦‚æ£€æŸ¥æœªåˆå§‹åŒ–çš„å€¼ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­è¿˜æ„å»ºäº†æ›´åŠ è„±ç³–çš„ THIRï¼ˆTyped HIRï¼‰ï¼ŒTHIR ä¸»è¦ç”¨äº pattern checking æ£€æŸ¥ã€‚</p>
<p><strong>Code generation</strong>: ä¸»è¦åŸºäº LLVM åšä»£ç ç”Ÿæˆï¼Œä¹Ÿæ”¯æŒ Craneliftã€‚</p>
<h2 id="ç¼–è¯‘å…¥å£"><a href="#ç¼–è¯‘å…¥å£" class="headerlink" title="ç¼–è¯‘å…¥å£"></a>ç¼–è¯‘å…¥å£</h2><p>å½“æˆ‘ä»¬è¿è¡Œç¼–è¯‘å‘½ä»¤ <code>rustc main.rs</code> æ—¶ï¼Œç¼–è¯‘å™¨é¦–å…ˆä¼šé€šè¿‡ <a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_driver_impl/src/lib.rs">rustc_driver</a> è¿™ä¸ªæœ€ä¸Šå±‚çš„ç»„ä»¶æ¥å¤„ç†è¾“å…¥å‚æ•°ï¼Œç„¶åè°ƒç”¨æ›´åŸºç¡€çš„ç»„ä»¶æ¥å¯åŠ¨ç¼–è¯‘è¡Œä¸ºã€‚</p>
<p>ç¼–è¯‘å™¨çš„å…¥å£åœ¨äº <a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/blob/5983a3a99ea631da9d7d1ce510a6761913f92a89/compiler/rustc/src/main.rs#L64">rustc_driver::main</a>ï¼Œæ¥ç€è°ƒç”¨ï¼š<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">RunCompiler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> callbacks<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<p>çœŸæ­£çš„è·‘ç¼–è¯‘æµç¨‹çš„è¿‡ç¨‹åœ¨äº <a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/blob/f77bfb7336f21bfe6a5fb5f7358d4406e2597289/compiler/rustc_driver_impl/src/lib.rs#L232">run_compiler</a>ï¼Œä¸»è¦æµç¨‹è¿˜æ˜¯ <code>Parsing</code>ï¼Œ<code>Analysising</code>ï¼Œ<code>Linking</code>ã€‚æˆ‘ä»¬çœ‹åˆ°å¾ˆå¤šè°ƒç”¨æ˜¯ä»ä¸€ä¸ªå«åš <code>queries</code> çš„ä¸œè¥¿å¼€å§‹çš„ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li><code>queries.parse()</code>ï¼Œ</li>
<li><code>queries.global_ctxt()?.enter(|tcx| tcx.analysis(()))</code></li>
</ul>
<p>è¿™æ˜¯ Rust ç¼–è¯‘å™¨çš„ä¸€ä¸ªç‰¹ç‚¹ï¼Œæ­£åœ¨ä»ä¼ ç»Ÿçš„ <code>pass-based</code> æ–¹å¼è½¬å‘ <code>demand-driven</code>ï¼ŒæŒ‰éœ€ç¼–è¯‘çš„ä¸»è¦æ€è·¯æ˜¯æ—¢ç„¶ç¼–è¯‘æ˜¯å…¸å‹çš„è¾“å…¥è¾“å‡ºç³»ç»Ÿï¼ŒåŒä¸€ä¸ªè¾“å…¥çš„è¾“å‡ºæ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥é€‚åˆç”¨ç¼“å­˜æ¥å‡å°‘é‡å¤è®¡ç®—ã€‚è¿™æ˜¯ç®—æ³•è®¾è®¡ä¸­ <code>Memoization</code> çš„æ€è·¯ï¼Œè¯¦ç»†çš„è®¾è®¡æ–‡æ¡£åœ¨ <a target="_blank" rel="noopener" href="https://github.com/nikomatsakis/rustc-on-demand-incremental-design-doc/blob/master/0000-rustc-on-demand-and-incremental.md">rustc-on-demand-and-incremental</a>ã€‚</p>
<p>å¥½å¤„ä¸»è¦åœ¨äºå¢é‡ç¼–è¯‘æ—¶åŠ å¿«ç¼–è¯‘é€Ÿåº¦ï¼Œç»“æœå°±æ˜¯ç”¨æˆ·æ›´æ”¹çš„å°‘é‡çš„ä»£ç ï¼Œç¼–è¯‘é€Ÿåº¦ä¼šæ›´å¿«ã€‚å¦å¤–ä¸€ä¸ªåŸå› æ˜¯è¿™æ ·æ–¹ä¾¿å¹¶è¡Œç¼–è¯‘ã€‚</p>
<p>ä½†ç›®å‰è¿˜æœ‰å¾ˆå¤š <code>phase</code> å¹¶æ²¡æœ‰å®Œå…¨å®ç°è¿™ç§æŒ‰éœ€å¤„ç†çš„æ–¹å¼ï¼Œç›®å‰åªæœ‰ <code>HIR</code> åˆ° <code>LLVM IR</code> ä¹‹é—´çš„æ­¥éª¤æ˜¯æŸ¥è¯¢çš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°é»˜è®¤çš„ <a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_interface/src/passes.rs#L626">query provider</a>:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">static</span> <span class="token constant">DEFAULT_QUERY_PROVIDERS</span><span class="token punctuation">:</span> <span class="token class-name">LazyLock</span><span class="token operator">&lt;</span><span class="token class-name">Providers</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">LazyLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> providers <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Providers</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    providers<span class="token punctuation">.</span>analysis <span class="token operator">=</span> analysis<span class="token punctuation">;</span>
    providers<span class="token punctuation">.</span>hir_crate <span class="token operator">=</span> <span class="token namespace">rustc_ast_lowering<span class="token punctuation">::</span></span>lower_to_hir<span class="token punctuation">;</span>
    providers<span class="token punctuation">.</span>output_filenames <span class="token operator">=</span> output_filenames<span class="token punctuation">;</span>
    providers<span class="token punctuation">.</span>resolver_for_lowering <span class="token operator">=</span> resolver_for_lowering<span class="token punctuation">;</span>
    <span class="token namespace">proc_macro_decls<span class="token punctuation">::</span></span><span class="token function">provide</span><span class="token punctuation">(</span>providers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">...</span><span class="token punctuation">.</span>
    <span class="token namespace">rustc_codegen_ssa<span class="token punctuation">::</span></span><span class="token function">provide</span><span class="token punctuation">(</span>providers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>providers
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ³¨æ„è¿™äº› <code>provider</code> æ˜¯æŒ‰ç…§ <code>crate</code> è¿™ä¸ªç»´åº¦æ¥ç»„ç»‡çš„ï¼Œæˆ‘åœ¨æ—¥å¸¸å¼€å‘ä¸­ç»å¸¸ç¢°åˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚æœæˆ‘åˆ‡æ¢äº† <code>compiler</code> çš„ä»£ç åˆ†æ”¯ï¼Œç„¶åç›´æ¥è¿›è¡Œå¢é‡ç¼–è¯‘ï¼Œæœ€ç»ˆé“¾æ¥çš„æ—¶å€™æŠ¥é”™ï¼Œè¿™å¤§æ¦‚æ˜¯å› ä¸ºæŸäº› <code>crate</code> çš„ä»£ç å˜äº†ï¼Œè€Œç¼“å­˜çš„ç»“æœæ˜¯è€çš„ï¼Œé‡æ–° <code>clean</code> åç¼–è¯‘å°±å¥½äº†ï¼Œä»¥åå†æ’æŸ¥ä¸€ä¸‹å…·ä½“åŸå› ã€‚</p>
<p><code>query</code> å¼•å…¥çš„å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯å¯¼è‡´é”™è¯¯å †æ ˆç‰¹åˆ«é•¿ï¼Œåœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ç»å¸¸ç¢°åˆ°å‡ ç™¾è¡Œçš„å †æ ˆä¿¡æ¯ï¼Œæˆ‘æ‰“ç®—åœ¨è¿™ä¸ª <a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/issues/107910">Issue</a> é‡Œå°è¯•è§£å†³ã€‚</p>
<h2 id="Lexing"><a href="#Lexing" class="headerlink" title="Lexing"></a>Lexing</h2><p>Lexing çš„è¿‡ç¨‹å’Œå…¶ä»–ç¼–è¯‘å™¨ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºç»™å®šå­—ç¬¦ä¸²çš„æºæ–‡ä»¶ï¼Œè¾“å‡ºä¸€ä¸ª token çš„æ•°ç»„ã€‚å¯¹åº”çš„ä»£ç åœ¨ <a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/blob/5983a3a99ea631da9d7d1ce510a6761913f92a89/compiler/rustc_lexer/src/lib.rs#L326">compiler/rustc_lexer</a>ï¼Œè¿™ä¸ª <code>advance_token</code> å°±æ˜¯è¯»å–ä¸‹ä¸€ä¸ª tokenã€‚</p>
<p>ä½†æ˜¯ Rust lexing è¿‡ç¨‹ä¸­çš„ç‰¹æ®Šç‚¹åœ¨äºè¾“å‡ºä¸ºä¸€ä¸ªç§°ä¹‹ä¸º token æµçš„ä¸œè¥¿ï¼Œ<code>advance_token</code> è¢«ä¸€ä¸ªå«åš <code>tokentrees.rs</code> çš„æ¨¡å—è°ƒç”¨ï¼Œå¤„ç†åçš„ç»“æœæ˜¯ <code>TokenStream</code>ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ä¸€ç»„ Tokenï¼Œåªæ˜¯å®šä¹‰ä¸ºä¸€ä¸ªæ ‘å½¢çš„ç»“æ„ï¼š</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">TokenStream</span><span class="token punctuation">(</span><span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token class-name">Lrc</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">TokenTree</span><span class="token operator">>></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å…¶å®šä¹‰ä¸ºï¼š<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">TokenTree</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/// A single token.</span>
    <span class="token class-name">Token</span><span class="token punctuation">(</span><span class="token class-name">Token</span><span class="token punctuation">,</span> <span class="token class-name">Spacing</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/// A delimited sequence of token trees.</span>
    <span class="token class-name">Delimited</span><span class="token punctuation">(</span><span class="token class-name">DelimSpan</span><span class="token punctuation">,</span> <span class="token class-name">Delimiter</span><span class="token punctuation">,</span> <span class="token class-name">TokenStream</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>è‡³äºä¸ºä»€ä¹ˆè¿”å›çš„æ˜¯è¿™ä¸ªæ ‘å½¢ç»“æ„ï¼Œå¯ä»¥å‚è€ƒè¿™é‡Œ <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/40302026/what-does-the-tt-metavariable-type-mean-in-rust-macros">What does the tt metavariable type mean in Rust macros</a> å’Œ <a target="_blank" rel="noopener" href="https://danielkeep.github.io/tlborm/book/mbe-syn-source-analysis.html">TokenTrees</a> ç®€è€Œè¨€ä¹‹å°±æ˜¯ä¸ºäº†å¤„ç†å®ã€‚</p>
<p>ä¸ºäº†çœ‹çœ‹è¿™ä¸ª Lexing çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸ªç®€å•çš„ç¨‹åºæ¥çœ‹çœ‹ä¸­é—´ç»“æœï¼š</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"a = &#123;&#125;"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨è¿™é‡Œ <a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/blob/f77bfb7336f21bfe6a5fb5f7358d4406e2597289/compiler/rustc_parse/src/lexer/mod.rs#L65">parse_token_trees</a>ä¿®æ”¹ä»£ç æ¥æŠŠ <code>TokenTree</code> æ‰“å°å‡ºæ¥ï¼š</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">ref</span> token_trees<span class="token punctuation">)</span> <span class="token operator">=</span> token_trees <span class="token punctuation">&#123;</span>
    <span class="token macro property">debug!</span><span class="token punctuation">(</span><span class="token string">"token_trees: &#123;:#?&#125;"</span><span class="token punctuation">,</span> token_trees<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>é€šè¿‡ç¯å¢ƒå˜é‡æ¥æŠŠç¼–è¯‘å™¨è¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸­é—´ç»“æœæ‰“å°å‡ºæ¥ï¼Œé‡å®šå‘åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿è¡Œå‘½ä»¤ï¼š<br><pre class="line-numbers language-none"><code class="language-none">RUSTC_LOG&#x3D;debug rustc main.rs &gt; &#x2F;tmp&#x2F;r.log 2&gt;&amp;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªç¨‹åºçš„ <code>TokenTree</code> æ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="/images/ob_pasted-image-20230302081527.png" alt=""></p>
<p>ä¹Ÿå°±æ˜¯é€šè¿‡åˆ†éš”ç¬¦ <code>(...)</code> ã€<code>&#123;...&#125;</code>ã€<code>[...]</code> æŠŠ Token åˆ†ç»„ï¼Œæˆ‘æœ€è¿‘å¯¹è¿™ä¸ªæ¨¡å—åšäº†ä¸€äº›<a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/pull/108297">æ”¹è¿›å’Œé‡æ„</a>ï¼Œä»»ä½•åˆ†éš”ç¬¦ä¸åŒ¹é…çš„é—®é¢˜ä¼šæŠ¥é”™ç„¶åç»ˆæ­¢ç¼–è¯‘ï¼Œä¸»è¦åŸå› æ˜¯åˆ†éš”ç¬¦çš„ä¸åŒ¹é…ä¼šè®© Parser æ„é€ å‡ºå®Œå…¨é”™è¯¯çš„ <code>AST</code>ï¼Œè¿™æ ·è¯Šæ–­ä¿¡æ¯å°±ä¼šéå¸¸å¤šï¼Œè€Œå¤§å¤šæ•°å¯¹å¼€å‘è€…æ²¡æœ‰ç”¨ã€‚</p>
<h2 id="Parsing"><a href="#Parsing" class="headerlink" title="Parsing"></a>Parsing</h2><p>Rust ä½¿ç”¨çš„æ‰‹å†™çš„é€’å½’ä¸‹é™ï¼ˆè‡ªä¸Šè€Œä¸‹ï¼‰æ–¹æ³•è¿›è¡Œè¯­æ³•åˆ†æï¼Œè§£ææ˜¯æŒ‰è¯­ä¹‰æ„é€ ç»„ç»‡çš„ï¼Œå¯ä»¥åœ¨ <a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/tree/master/compiler/rustc_parse/src/parser">rust/compiler/rustc_parse/src/parser</a> ç›®å½•çœ‹åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š</p>
<ul>
<li><code>expr.rs</code></li>
<li><code>pat.rs</code></li>
<li><code>ty.rs</code></li>
<li><code>stmt.rs</code></li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æŠŠæ•´ä¸ªç¨‹åºçš„ <code>AST</code> æ‰“å°å‡ºæ¥ï¼Œè¿™å¯¹äºç¼–è¯‘å™¨å¼€å‘é˜¶æ®µæ¯”è¾ƒæœ‰å¸®åŠ©ï¼š</p>
<pre class="line-numbers language-console" data-language="console"><code class="language-console">rustc .&#x2F;p&#x2F;main.rs -Zunpretty&#x3D;ast-tree &gt; tree.log 2&gt;&amp;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å¦å¤–ï¼Œè¯»è¿™éƒ¨ä»£ç ç»“åˆ <a target="_blank" rel="noopener" href="https://doc.rust-lang.org/reference/">Rust Reference</a> ä¼šå®¹æ˜“å¾ˆå¤šï¼Œå› ä¸º parser å¾ˆå¤šæ—¶å€™å°±æ˜¯ reference çš„ç›´è¯‘ï¼Œçœ‹æ‡‚äº† reference å°±å®¹æ˜“çœ‹æ‡‚ parsingã€‚</p>
<h3 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h3><p>ä¸ºä»€ä¹ˆ Rust ä¸ç”¨é‚£äº›é«˜çº§çš„ parsing å·¥å…·è€Œé‡‡ç”¨æ‰‹å†™çš„æ–¹å¼ï¼Œæˆ‘è®¤ä¸ºä¸€ä¸ªåŸå› åœ¨äºæ‰‹å†™èƒ½ç»™å‡ºæ›´å¥½çš„è¯Šæ–­ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ° <code>parser</code> ä¸­å¾ˆå¤šä»£ç åœ¨å°è¯•ä»é”™è¯¯ä¸­æ¢å¤ï¼Œæ¯”å¦‚ç”¨æˆ·å†™äº†ä¸‹é¢è¿™ä¸ªç¨‹åºï¼š</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">const</span> <span class="token constant">FOO</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å½“ Parser å¤„ç†åˆ° <code>&#123;</code> è¿™ä¸ªä½ç½®ï¼Œè¿™é‡Œçœ‹èµ·æ¥ç”¨æˆ·æƒ³å†™çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½†æŠŠ <code>[</code> å†™æˆäº† <code>&#123;</code>ï¼Œ<code>Parser</code> ä¸­çš„è¿™æ®µä»£ç ä¼šå…ˆæŠŠå½“å‰çš„çŠ¶æ€å­˜å‚¨ä¸ºä¸€ä¸ª <code>snapshot</code>ï¼Œç„¶åå°è¯• <code>1, 2, 3</code> æ˜¯å¦èƒ½ parse æˆä¸€ä¸ªæ•°ç»„å…ƒç´ ï¼Œå¦‚æœæ˜¯åˆ™èƒ½ç»™å‡ºä¸€ä¸ªæ›´ä¸ºä¼˜åŒ–çš„è¯Šæ–­ä¿¡æ¯ï¼Œå¦‚æœä¸èƒ½åˆ™æ¢å¤åˆ°ä¿å­˜çš„ <code>snapshot</code>ï¼š</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">maybe_suggest_brackets_instead_of_braces</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> lo<span class="token punctuation">:</span> <span class="token class-name">Span</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">&lt;</span><span class="token class-name">Expr</span><span class="token operator">>></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> snapshot <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">create_snapshot_for_diagnostic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> snapshot<span class="token punctuation">.</span><span class="token function">parse_array_or_repeat_expr</span><span class="token punctuation">(</span><span class="token class-name">Delimiter</span><span class="token punctuation">::</span><span class="token class-name">Brace</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// emit better error here</span>
            <span class="token punctuation">...</span>

            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">restore_snapshot</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">mk_expr_err</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>span<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">None</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>Parser</code> ä¸­å¾ˆå¤šä»£ç éƒ½åœ¨å¤„ç†ç±»ä¼¼è¿™ç§é€»è¾‘ã€‚é”™è¯¯å¤„ç†ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è¯é¢˜ï¼Œåœ¨ <code>parsing</code> è¿™ä¸ªé˜¶æ®µèƒ½åšçš„éƒ½æ˜¯æ˜æ˜¾çš„è¯­æ³•å±‚é¢çš„å¤„ç†ã€‚</p>
<h3 id="å®å±•å¼€"><a href="#å®å±•å¼€" class="headerlink" title="å®å±•å¼€"></a>å®å±•å¼€</h3><p>åœ¨ <code>Parsing</code> çš„è¿‡ç¨‹ä¸­ä¼šé‡åˆ°å®ï¼Œä½†å®å¤„ç†éœ€è¦åœ¨ <code>AST</code> æ„å»ºä¹‹åï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ‰€æœ‰çš„å®ä¼šé€šè¿‡å ä½ç¬¦æ¥ç‰¹æ®Šæ ‡è¯†ã€‚</p>
<p>ç›¸å¯¹ <code>Parsing</code>ï¼Œå®å±•å¼€æ˜¯ä¸€ä¸ªæ›´ä¸ºå¤æ‚çš„è¿‡ç¨‹ï¼Œ<code>AST</code> æœ‰äº†ä¹‹åä¼š <code>driver</code> ä¼šé€šè¿‡ä¸€ä¸‹è°ƒç”¨è·¯å¾„æ¥é€ä¸ª crate å±•å¼€å®ï¼š</p>
<pre><code>resolver_for_lowering -&gt; configure_and_expand -&gt; expand_crate -&gt; fully_expand_fragment
</code></pre><p><a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_expand/src/expand.rs#L409"><code>fully_expand_fragment</code></a> è¿™ä¸ªå‡½æ•°æ˜¯å®å±•å¼€çš„ä¸»è¦ç®—æ³•ï¼Œé¦–å…ˆæ‰¾åˆ° AST ä¸­çš„å ä½ç¬¦ï¼Œç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç„¶åä¸æ–­åœ°å»å±•å¼€ç›´åˆ°æ‰€æœ‰çš„å®å ä½ç¬¦éƒ½å¤„ç†å®Œæ¯•ï¼Œå†ç»Ÿä¸€åŠ åˆ° AST ä¸­å»ï¼Œè¿™æ˜¯å› ä¸ºå®ä»£ç ä¸­ä¹Ÿå¯èƒ½åŒ…å«å®ï¼Ÿå¦‚æœæŸæ¬¡è¿­ä»£æ²¡æœ‰å±•å¼€ä¸€ä¸ªå®è¯´æ˜æœ‰è¯­æ³•é—®é¢˜ã€‚</p>
<h3 id="Name-resolution"><a href="#Name-resolution" class="headerlink" title="Name resolution"></a>Name resolution</h3><p><code>Name resolution</code> å°±æ˜¯è§£æ <code>AST</code> ä¸­çš„æ‰€æœ‰åå­—ï¼ŒåŒ…æ‹¬å˜é‡åã€å‡½æ•°åã€ç±»å‹åã€ç”Ÿå‘½å‘¨æœŸçš„å‘½åç­‰ç­‰ã€‚<br>åœ¨å®å±•å¼€çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªå¤„ç†äº† <code>import</code>ï¼Œè€Œå¹¶æ²¡æœ‰å…³æ³¨æ‰€æœ‰çš„åå­—è§£æï¼Œæ‰€æœ‰çš„å‘½åéœ€è¦ç­‰åˆ°å®å±•å¼€å¤„ç†äº†ä¹‹åä¸“é—¨æ¥è§£æåå­—ï¼Œè¿™ä¹Ÿæ˜¯è¿™éƒ¨åˆ†ä»£ç å¾ˆå¤šå‡½æ•°çš„åå­—å«åš <code>late_*</code>ï¼Œå¾ˆå¤šé€»è¾‘åœ¨ä¸€ä¸ªå«ä½œ <code>late.rs</code> çš„æ–‡ä»¶é‡Œã€‚ä½†æˆ‘ä»¬å¹¶æ²¡æœ‰çœ‹åˆ°ä¸€ä¸ª <code>early.rs</code> çš„æ–‡ä»¶ï¼Œå› ä¸ºè¢«æ‹†åˆ†æˆäº†ä¸‰ä¸ªæ–‡ä»¶ï¼š<code>build_reduced_graph.rs</code>, <code>macros.rs</code> å’Œ <code>imports.rs</code>ã€‚</p>
<p>æˆ‘ä»¬æ¥å†™ä¸ªç¨‹åºåŒ…å«ä¸€ä¸ªæ˜æ˜¾çš„å˜é‡ <code>a</code> æœªå®šä¹‰ï¼š<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></p>
<p>ç¼–è¯‘å™¨åœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­è‚¯å®šä¼šæŠ¥é”™ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æŠŠç¬¬ä¸€ä¸ªé”™è¯¯ä¿¡æ¯å½“ä½œä¸€ä¸ª <code>bug</code>ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è·å¾—è¿™ä¸ªæŠ¥é”™çš„è°ƒç”¨å †æ ˆï¼Œè¿™æ˜¯è°ƒè¯•ç¼–è¯‘å™¨ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„å°æŠ€å·§ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rustc ./p/main.rs <span class="token parameter variable">-Z</span> treat-err-as-bug<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>é€šè¿‡æŸ¥çœ‹å †æ ˆæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é”™è¯¯æ˜¯åœ¨è¿™é‡Œå‡ºç°çš„ï¼Œå› æ­¤æˆ‘ä»¬æ‰¾åˆ°äº† <code>name resolving</code> çš„å…¥å£åœ¨<a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/blob/f77bfb7336f21bfe6a5fb5f7358d4406e2597289/compiler/rustc_resolve/src/lib.rs#L1483">resolve_crate</a>ï¼š</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">/// Entry point to crate resolution.</span>
 <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">resolve_crate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> krate<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Crate</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">self</span><span class="token punctuation">.</span>tcx<span class="token punctuation">.</span>sess<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">"resolve_crate"</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">self</span><span class="token punctuation">.</span>tcx<span class="token punctuation">.</span>sess<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">"finalize_imports"</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">finalize_imports</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                                 <span class="token class-name">EffectiveVisibilitiesVisitor</span><span class="token punctuation">::</span><span class="token function">compute_effective_visibilities</span><span class="token punctuation">(</span>sel          <span class="token punctuation">...</span>
         <span class="token keyword">self</span><span class="token punctuation">.</span>tcx<span class="token punctuation">.</span>sess<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">"late_resolve_crate"</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">late_resolve_crate</span><span class="token punctuation">(</span>krate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">self</span><span class="token punctuation">.</span>tcx<span class="token punctuation">.</span>sess<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">"resolve_main"</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">resolve_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">self</span><span class="token punctuation">.</span>tcx<span class="token punctuation">.</span>sess<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">"resolve_check_unused"</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">check_unused</span><span class="token punctuation">(</span>krate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">self</span><span class="token punctuation">.</span>tcx<span class="token punctuation">.</span>sess<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">"resolve_report_errors"</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">report_errors</span><span class="token punctuation">(</span>krate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">self</span><span class="token punctuation">.</span>tcx
             <span class="token punctuation">.</span>sess
             <span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">"resolve_postprocess"</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">crate_loader</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>c<span class="token closure-punctuation punctuation">|</span></span> c<span class="token punctuation">.</span><span class="token function">postprocess</span><span class="token punctuation">(</span>krate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">// Make sure we don't mutate the cstore from here on.</span>
     <span class="token keyword">self</span><span class="token punctuation">.</span>tcx<span class="token punctuation">.</span><span class="token function">untracked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cstore<span class="token punctuation">.</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å…¶ä¸­ <code>self.late_resolve_crate(krate)</code> å°±æ˜¯æŒ‰ç…§ <code>crate</code> é€ä¸ªå»è§£æé‡Œé¢çš„ <code>name</code>ï¼Œè€Œ <code>self.resolve_main()</code> æ˜¯æ‰¾æ•´ä¸ªç¨‹åºä¸­æ˜¯å¦å­˜åœ¨ <code>main</code>ã€‚<code>LateResolutionVisitor</code> å°±æ˜¯ç”¨æ¥é€’å½’åœ°éå† <code>AST</code> é‡Œçš„å…ƒç´ ï¼Œæ¯”å¦‚ <code>resolve_local</code>ï¼Œ<code>resolve_params</code> ç­‰ç­‰ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå«åš <a target="_blank" rel="noopener" href="https://doc.rust-lang.org/stable/nightly-rustc/rustc_resolve/late/struct.Rib.html#"><code>rib</code></a>ï¼Œæˆ‘ä¼°è®¡æ˜¯ <code>Rust internal block</code> çš„ç®€ç§°ğŸ¤”ï¼Œè¿™é‡Œæœ‰<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/stable/nightly-rustc/rustc_resolve/late/enum.RibKind.html">å„ç§ç±»å‹çš„ <code>rib</code></a>ï¼Œä¸€ä¸ª <code>rib</code> å°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªå‘½åç©ºé—´å’Œå…¶å¯¹åº”çš„ <code>binding</code>:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Rib</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">R</span> <span class="token operator">=</span> <span class="token class-name">Res</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">pub</span> bindings<span class="token punctuation">:</span> <span class="token class-name">IdentMap</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> kind<span class="token punctuation">:</span> <span class="token class-name">RibKind</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ¯”å¦‚æˆ‘ä»¬å†™ä»£ç ä¸­çš„ä¸€ä¸ªå¤§æ‹¬å·å°±ä¼šå¼•å…¥ä¸€ä¸ªæ–°çš„ <code>rib</code>ï¼ŒåŒæ ·çš„ä¸€ä¸ªå‡½æ•°æˆ–è€…æ¨¡å—çš„å®šä¹‰ä¼šå¼•å…¥å¯¹åº”çš„ <code>rib</code>ã€‚å¯¹äºä»£ç ï¼š</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é‚£å¦‚ä½•èƒ½æ‰¾åˆ°åœ¨ <code>println!</code> çš„æ—¶å€™æ‰€ç”¨çš„å˜é‡ <code>a</code> å‘¢ï¼Ÿå› ä¸ºå˜é‡æ˜¯å¯ä»¥è¢«è¦†ç›–çš„ï¼Œå¯ä»¥æƒ³è±¡è¿™æ˜¯ä¸€ä¸ªæŒ‰ scope ä»é‡Œå¾€å¤–æ‰¾çš„è¿‡ç¨‹ï¼Œä»ä»£ç ä¸Šä¹Ÿå¯ä»¥éªŒè¯è¿™ä¸ªçŒœæƒ³ï¼Œ<a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_resolve/src/ident.rs#L279">resolve_ident_in_lexical_scope</a> å‡½æ•°å°±æ˜¯è¿™æ ·å®ç°çš„ã€‚</p>
<p>åœ¨åå­—è§£æçš„è¿‡ç¨‹ä¸­ï¼ŒRust åˆ†åˆ«ä¸º typesã€valuesã€macros ä¿å­˜äº†ä¸åŒçš„å‘½åç©ºé—´ï¼Œå› æ­¤ä¸‹é¢è¿™æ ·çš„ä»£ç è™½ç„¶çœ‹èµ·æ¯”è¾ƒè¯¡å¼‚ä½†å´æ˜¯åˆæ³•çš„ Rust ä»£ç ï¼š</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">type</span> <span class="token type-definition class-name">x</span> <span class="token operator">=</span> <span class="token keyword">u32</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> x<span class="token punctuation">:</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> y<span class="token punctuation">:</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// See? x is still a type here.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>åå­—è§£ææ˜¯éå¸¸å¤æ‚çš„éƒ¨åˆ†ï¼Œå…‰ <code>late.rs</code> è¿™ä¸ªæ–‡ä»¶å°±æœ‰ 4000 è¡Œä»£ç äº†ã€‚ä¹‹å‰æˆ‘åšè¿‡ä¸€ä¸ªå…³äº<a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/pull/104864/files">åå­—è§£æçš„ PR</a>ï¼Œå½“ä¸€ä¸ªå˜é‡æ²¡åœ¨å½“å‰ <code>scope</code> é‡Œæ‰¾åˆ°çš„æƒ…å†µä¸‹å°è¯•å» <code>inner scope</code> æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°åˆ™ç»™å‡ºå»ºè®®ã€‚è¿™è™½ç„¶æ˜¯ä¸ªä¸å¤æ‚çš„ PRï¼Œä½†æˆ‘é€šè¿‡è¿™ä¸ª PR ç†è§£äº†è¿™å—çš„å¤§è‡´é€»è¾‘ã€‚</p>
<h3 id="Ast-validation"><a href="#Ast-validation" class="headerlink" title="Ast validation"></a>Ast validation</h3><p>è¿™ä¸ªé˜¶æ®µæ²¡åšä»€ä¹ˆç‰¹åˆ«å¤æ‚çš„æ£€æŸ¥ï¼Œæ¯”å¦‚è¿™ç§ï¼š</p>
<ul>
<li>no more than <code>u16::MAX</code> parameters;</li>
<li>c-variadic functions are declared with at least one named argument;</li>
<li>c-variadic argument goes the last in the declaration;</li>
<li>documentation comments arenâ€™t applied to function parameters;</li>
</ul>
<p><code>AstValidator</code> å®ç°äº†å„ç§ <code>check_*</code> å‡½æ•°ï¼Œé€šè¿‡ <code>visitor pattern</code> åœ¨ AST é‡Œé€ä¸ªæ£€æŸ¥å¯¹åº”çš„å…ƒç´ ï¼Œåœ¨ç¼–è¯‘å™¨ä¸­æœ€å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼å°±æ˜¯ <code>visitor pattern</code> ï¼Œæ‰€ä»¥åœ¨ <code>rust_ast</code> é‡Œå®šä¹‰äº†è¿™ä¸ª <a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/blob/13471d3b2046cce78181dde6cfc146c09f55e29e/compiler/rustc_ast/src/visit.rs#L111">Visitor</a> çš„ <code>trait</code>ï¼š</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Visitor</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ast</span><span class="token operator">></span><span class="token punctuation">:</span> <span class="token class-name">Sized</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_ident</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> _ident<span class="token punctuation">:</span> <span class="token class-name">Ident</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_foreign_item</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> i<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'ast</span> <span class="token class-name">ForeignItem</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">walk_foreign_item</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_item</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> i<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'ast</span> <span class="token class-name">Item</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">walk_item</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_local</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> l<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'ast</span> <span class="token class-name">Local</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">walk_local</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_block</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'ast</span> <span class="token class-name">Block</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">walk_block</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‰€æœ‰çš„è‡ªå®šä¹‰ <code>Visitor</code> åªéœ€è¦å®ç°è¿™ä¸ª <code>trait</code> å°±è¡Œäº†ï¼š</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">Visitor</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token class-name">AstValidator</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_attribute</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> attr<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Attribute</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token namespace">validate_attr<span class="token punctuation">::</span></span><span class="token function">check_attr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span>parse_sess<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> expr<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Expr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">...</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="HIR"><a href="#HIR" class="headerlink" title="HIR"></a>HIR</h2><p>HIR æ˜¯ rustc ä¸­ä½¿ç”¨çš„ä¸»è¦ IRï¼Œæ˜¯åœ¨è§£æã€å®æ‰©å±•å’Œå‘½åè§£æä¹‹åç”Ÿæˆçš„ã€‚HIR çš„è®¸å¤šéƒ¨åˆ†ä¸ Rust è¡¨é¢è¯­æ³•éå¸¸ç›¸ä¼¼ï¼Œé™¤äº† Rust çš„ä¸€äº›è¡¨è¾¾å¼å½¢å¼å·²è¢«è„±ç³–ã€‚ä¾‹å¦‚ï¼Œ <code>for</code> å¾ªç¯è¢«è½¬æ¢ä¸º <code>loop</code> å¹¶ä¸”ä¸å‡ºç°åœ¨ HIR ä¸­ï¼Œè¿™ä½¿å¾— HIR æ¯”æ™®é€š AST æ›´æ˜“äºåˆ†æã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å±•ç¤ºä¸€ä¸ªç¨‹åºçš„ <code>HIR</code> :</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rustc main.rs <span class="token parameter variable">-Z</span> <span class="token assign-left variable">unpretty</span><span class="token operator">=</span>hir-tree <span class="token operator">></span> tree.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å³ä½¿ä¸€ä¸ªéå¸¸ç®€å•çš„ç¨‹åºï¼Œç”Ÿäº§çš„ <code>hir</code> ä¹Ÿæ˜¯éå¸¸é•¿çš„ï¼Œå› ä¸ºå¸¦äº†å¾ˆå¤šç¼–è¯‘å™¨é‡Œé¢åˆ†æä½¿ç”¨çš„å­—æ®µï¼Œå¦å¤– <code>HIR</code> ä¸­ä¹Ÿå¸¦æœ‰å¯¹åº”çš„ä»£ç è¡Œï¼Œä¹ŸåŒ…æ‹¬ <code>Span</code> ç­‰è¿™äº›ä¿¡æ¯ï¼Œå¯¹ç”Ÿæˆè¯Šæ–­éå¸¸é‡è¦ã€‚<code>rustc_hir/src/intravisit.rs</code>  å®šä¹‰äº†ä¸€äº›æ–¹ä¾¿åœ¨ <code>HIR</code> ä¸Šéå†çš„ <code>visitor</code>ã€‚</p>
<p>HIR å’Œ AST åŸºæœ¬æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ‰€ä»¥æ•´ä¸ªè½¬æ¢çš„è¿‡ç¨‹å°±æ˜¯éå†ä¸€é ASTï¼Œä»£ç åœ¨ <code>rustc_ast_lowering</code>ã€‚æ³¨æ„ HIR é‡Œçš„ <code>HirId</code> éå¸¸é‡è¦ï¼Œè¿™ä¸ª ID æ˜¯åç»­ä½¿ç”¨ HIR æ—¶å€™ç»å¸¸ä¼šç”¨åˆ°çš„ï¼Œæ‰€ä»¥å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚åœ¨ lowering çš„è¿‡ç¨‹ä¸­é€šè¿‡ <code>next_id</code>è¿™ä¸ªå‡½æ•°æ¥ç”Ÿæˆå”¯ä¸€çš„ IDã€‚</p>
<p>æˆ‘æ›¾ç»å°è¯•åšè¿‡ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ PR æ¥ä¿è¯çˆ¶èŠ‚ç‚¹çš„ HIR_ID ä¸€å®šæ¯”å­èŠ‚ç‚¹çš„å°ï¼Œä½†æ˜¯åšåˆ°åæ¥å‘ç°ä»£ç ä¸­çš„é€’å½’ç»å¸¸éœ€è¦å…ˆåˆ›å»ºå­èŠ‚ç‚¹ï¼Œç„¶åå†åˆ›å»ºçˆ¶èŠ‚ç‚¹ï¼Œè¿™æ · HIR_ID å°±å¾ˆéš¾ä¿è¯é¡ºåºï¼Œå¦åˆ™ä»£ç å°±æ”¹å¾—å¾ˆéš¾çœ‹ã€‚å¦‚æœä½ æ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹èƒ½å¦ç»§ç»­åšä¸‹å» <a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/pull/103114/files">Assign HirIds in HIR traversal order</a>ã€‚</p>
<p>è¯­æ³•ç³–ä»€ä¹ˆçš„éƒ½ä¼šåœ¨è¿™æ—¶å€™å¤„ç†æ‰ã€‚</p>
<h3 id="Type-Inference"><a href="#Type-Inference" class="headerlink" title="Type Inference"></a>Type Inference</h3><p>ç±»å‹æ¨æ–­æ˜¯è‡ªåŠ¨æ£€æµ‹è¡¨è¾¾å¼ç±»å‹çš„è¿‡ç¨‹ï¼Œæ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> things <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    things<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"thing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å¹¶æ²¡æœ‰æ˜¾ç¤ºå£°æ˜ things çš„ç±»å‹ï¼Œä½†æ˜¯å› ä¸ºåç»­ä»£ç ä¸­å¾€ things é‡Œå†™å…¥äº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ things çš„ç±»å‹å¯ä»¥æ¨æ–­å‡ºæ˜¯ <code>Vec&lt;&amp;str&gt;</code>ã€‚</p>
<p>Rust ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªæ”¹è¿›ç‰ˆæœ¬çš„ <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Hindley%E2%80%93Milner_type_system">Hindley-Milner (HM)</a> ç®—æ³•ï¼Œè¯¥ç®—æ³•æœ€å…ˆè¢«å®ç°åœ¨ ML ç³»çš„ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œåæ¥è¢«å¹¿æ³›é‡‡ç”¨åœ¨å„ç§å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€é‡Œã€‚</p>
<p>è¿™å—æˆ‘ç›®å‰æ¥è§¦ä¹Ÿæ¯”è¾ƒå°‘ï¼Œè®°å¾—ä¹‹å‰åšè¿‡ä¸€ä¸ª PR å°è¯•ä¿®å¤ä¸€ä¸ª type inference çš„å°é—®é¢˜ï¼Œä¸è¿‡æ²¡åšå®Œ  <a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/pull/107567">Extend Infer ty for binary operators</a>ï¼Œé—®é¢˜çœ‹èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">myfunction</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> one <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>i<span class="token punctuation">,</span> a<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        a<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment">// ok</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> two <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>i<span class="token punctuation">,</span> a<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token operator">!</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">// cannot infer type</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> three <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>i<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> a<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token operator">!</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">// ok</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token function">one</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">two</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">three</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å˜é‡ <code>two</code> ä¸èƒ½è¢«æ¨å¯¼å‡ºæ¥æ˜¯å› ä¸º <code>i</code> æ²¡æœ‰ç±»å‹ï¼Œè™½ç„¶æˆ‘ä»¬çŸ¥é“ <code>a</code> çš„ç±»å‹æ˜¯ <code>Vec&lt;bool&gt;</code> ï¼Œä½†ä¸èƒ½ä¿è¯ <code>a[i]</code>å°±æ˜¯ <code>bool</code> ç±»å‹ï¼Œå¦‚æœä½ æ„Ÿå…´è¶£å¯ä»¥è¯•è¯•çœ‹èƒ½å¦è§£å†³ã€‚</p>
<p>Type inference æœ‰å…¶å±€é™æ€§ï¼Œ2015 å¹´ RFC <a target="_blank" rel="noopener" href="https://rust-lang.github.io/rfcs/0803-type-ascription.html">0803-type-ascription</a> æå‡ºæ¥ä½œä¸ºè¡¥å……ï¼Œä½†è¿™ä¸ª RFC å®ç°äº†ä¹‹åä¸€ç›´æ²¡æœ‰ç¨³å®šï¼Œæœ€ç»ˆç¤¾åŒºåˆæå‡ºæŠŠè¿™ä¸ªåŠŸèƒ½ç»™å»æ‰ï¼Œè€Œè¿™ä¸ªå·¥ä½œä¹Ÿæ¶‰åŠåˆ°å¤§é‡çš„æ”¹åŠ¨ï¼š<a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/issues/101728">De-RFC 3307: Remove type ascription</a>ã€‚</p>
<h2 id="MIR"><a href="#MIR" class="headerlink" title="MIR"></a>MIR</h2><p>MIR æ˜¯æ¯” HIR æ›´ä½å±‚æ¬¡çš„ä¸­é—´è¡¨ç¤ºï¼Œä» HIR æ„å»ºã€‚MIR æ–¹ä¾¿ç”¨äºæ§åˆ¶æµåˆ†æå’Œä»£ç ä¼˜åŒ–ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬ Rust ç‰¹æ®Šçš„ <strong>borrow checking</strong>ã€‚MIR çš„å…³é”®ç‰¹æ€§ï¼š</p>
<p>MIR çš„ä¸€äº›å…³é”®ç‰¹æ€§æ˜¯ï¼š</p>
<ul>
<li>åŸºäºæ§åˆ¶æµå›¾</li>
<li>æ²¡æœ‰åµŒå¥—è¡¨è¾¾å¼</li>
<li>MIR ä¸­çš„æ‰€æœ‰ç±»å‹éƒ½æ˜¯å®Œå…¨æ˜¾å¼çš„</li>
</ul>
<p>æ›´æ·±å…¥äº†è§£å¯ä»¥è¯»å®˜æ–¹çš„è¿™ç¯‡æ–‡ç«  <a target="_blank" rel="noopener" href="https://blog.rust-lang.org/2016/04/19/MIR.html">Introducing MIR</a>ã€‚MIR éƒ½æ˜¯ä¸€äº›æ¯”è¾ƒåŸå­æ€§çš„æ“ä½œï¼Œç¦» LLVM çš„ IR æ¯”è¾ƒè¿‘ï¼Œæ‰€ä»¥å¾ˆæ–¹ä¾¿åé¢ä»£ç ç”Ÿæˆéƒ¨åˆ†ã€‚å¦å¤–ä¸ºäº†æ–¹ä¾¿åš borrow checking MIR ä¹Ÿä¼šåœ¨æ’å…¥ä¸€äº› scope çš„æ ‡ç­¾ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <a target="_blank" rel="noopener" href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=30074856e62e74e91f06abd19bd72ece">Rust Playground</a> æŸ¥çœ‹ç”Ÿæˆå‡ºæ¥çš„ MIRï¼Œå¦‚ä½•åŸºäº MIR åšæ•°æ®æµåˆ†æå¯å‚è€ƒ <a target="_blank" rel="noopener" href="https://rustc-dev-guide.rust-lang.org/mir/dataflow.html">MIR dataflow</a>ï¼Œåœ¨ MIR ä¸Šåš <a target="_blank" rel="noopener" href="https://rustc-dev-guide.rust-lang.org/borrow_check.html#major-phases-of-the-borrow-checker">borrow checking</a> ä¹Ÿä¼šæ›´ç²¾å‡†ï¼ŒNLL(non-lexical lifetime) å°±æ˜¯è¿™æ ·è§£å†³çš„ã€‚</p>
<h2 id="Codegen-ä»£ç ç”Ÿæˆ"><a href="#Codegen-ä»£ç ç”Ÿæˆ" class="headerlink" title="Codegen ä»£ç ç”Ÿæˆ"></a>Codegen ä»£ç ç”Ÿæˆ</h2><p>ä¸€ç›´åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œç¼–è¯‘éƒ½æ˜¯åœ¨åšæ•°æ®è½¬æ¢ï¼ŒæŠŠä»£ç å˜æˆä¸­é—´å±‚è¡¨ç¤ºï¼Œç„¶åæŠ½è±¡çš„ç­‰çº§è¶Šæ¥è¶Šä½ï¼Œæœ€åæŠŠ MIR ç”Ÿæˆ LLVM IRï¼Œç„¶åç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<p>Rust åç«¯å¯ä»¥æ˜¯ LLVMã€Cranelift æˆ–è€… GCCï¼Œè¿™äº›éƒ½ä¾èµ–äºç¬¬ä¸‰æ–¹åº“æ¥å®ç°ï¼Œæ‰€ä»¥éœ€è¦æœ€å¤§ç¨‹åº¦å…±äº«ä¸€äº›åŸºç¡€ä»£ç ï¼ŒRust ç¼–è¯‘å™¨æœ¬èº«æœ‰è‡ªå·±çš„ LLVM ç»‘å®šåŒ…ã€‚</p>
<p>åœ¨è¿™ä¸ªé˜¶æ®µä¹Ÿåšäº†å¦‚ä¸‹è¿™äº›äº‹æƒ…ï¼š</p>
<ul>
<li>ä¸ºèŒƒæ€§ç±»å‹æ›¿æ¢æˆå…·ä½“çš„ç±»å‹</li>
<li>ä¸ºå…·ä½“ç±»å‹ç”Ÿæˆä»£ç ç§°ä¸ºå•æ€åŒ– (<em>monomorphization</em>)</li>
<li>MIR è½¬æ¢ä¸º codegen IR</li>
<li>è°ƒç”¨ codegen åç«¯ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</li>
</ul>
<p>ä»£ç ç”Ÿæˆçš„å…¥å£ç‚¹æ˜¯ <code>rustc_codegen_ssa::base::codegen_crate</code>ã€‚</p>
<hr>
<p>æ€»çš„æ¥è¯´ï¼Œæˆ‘ç†è§£ Rust æ˜¯åŠ äº†äº›ä¾¿äºåšé™æ€åˆ†æçš„è¯­è¨€ç‰¹æ€§ï¼Œæ¯”å¦‚ lifetime å’Œ borrow checking è§„åˆ™ï¼Œç¼–è¯‘å™¨å†…éƒ¨ä¹Ÿé›†æˆäº†å¾ˆå¤šé™æ€åˆ†æåŠŸèƒ½ã€‚</p>
<p>å½“ç„¶æˆ‘ä»¬åªæ˜¯ä»å¾ˆé«˜çš„ç»´åº¦å»å¿«é€Ÿè¿‡äº†ä¸€éï¼Œé‡Œé¢è¿˜æœ‰äº›ç‰¹æ®Šçš„éƒ¨åˆ†å¾ˆå¤æ‚ä½†æˆ‘è¿˜æ²¡å¼€å§‹ç»†çœ‹ï¼Œæ¯”å¦‚ <code>trait solving</code> ã€‚</p>
<p>åç»­ç»§ç»­æ›´æ–° ğŸ˜ã€‚</p>
</section>

    <p></p>
    <!-- äºŒç»´ç  START -->
    
        <div class="qrcode">
            <img src="/images/wechat-qr-code.jpg" height="160" width="160">
            <figcaption>å…¬å·åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ğŸ‘»</figcaption>
      </div>
    

    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#ç¼–ç¨‹" >
    <span class="tag-code">ç¼–ç¨‹</span>
  </a>

  <a href="/tags#Rust" >
    <span class="tag-code">Rust</span>
  </a>

  <a href="/tags#ç¼–è¯‘å™¨" >
    <span class="tag-code">ç¼–è¯‘å™¨</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2023/03/20/chatgpt-tools.html">
        <span class="nav-arrow">â† </span>
        
          äººç±»çš„ç»ˆæå·¥å…·
        
      </a>
    
    
      <a class="nav-right" href="/2023/03/06/apple-perf.html">
        
          è‹¹æœï¼šä¸ºäº†å®‰å…¨è®© M2 åƒç°
        
        <span class="nav-arrow"> â†’</span>
      </a>
    
  </div>

    <!-- NAV END -->

    <!-- äºŒç»´ç  END -->
    
      <!-- No Comment -->
    



    <script src="https://utteranc.es/client.js"
      repo="chenyukang/chenyukang.github.io"
      issue-term="pathname"
      theme="github-light"
      crossorigin="anonymous"
      async>
    </script>


  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title"></strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-nav-text">æ•´ä½“æ¶æ„</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%BC%96%E8%AF%91%E5%85%A5%E5%8F%A3"><span class="toc-nav-text">ç¼–è¯‘å…¥å£</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Lexing"><span class="toc-nav-text">Lexing</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Parsing"><span class="toc-nav-text">Parsing</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-nav-text">é”™è¯¯å¤„ç†</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%AE%8F%E5%B1%95%E5%BC%80"><span class="toc-nav-text">å®å±•å¼€</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Name-resolution"><span class="toc-nav-text">Name resolution</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Ast-validation"><span class="toc-nav-text">Ast validation</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#HIR"><span class="toc-nav-text">HIR</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Type-Inference"><span class="toc-nav-text">Type Inference</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#MIR"><span class="toc-nav-text">MIR</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Codegen-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90"><span class="toc-nav-text">Codegen ä»£ç ç”Ÿæˆ</span></a></li></ol>
    
  </div>
</aside>

  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://catcoding.me/2023/03/13/rustc-source.html';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

     // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW * 3 / 4}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer" id="footer">
    <p class="copyright">
        &copy;
        2024 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a> with <a target="_blank" rel="noopener" href="https://github.com/yanm1ng/hexo-theme-vexo">Vexo</a>
    </p>
</footer>

<script>
    function async(u, c) {
        var d = document,
            t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) {
            o.addEventListener('load', function(e) {
                c(null, e);
            }, false);
        }
        s.parentNode.insertBefore(o, s);
    }
</script>
<script>
    async("//catcoding.me/js/fastclick.min.js", function() {
        FastClick.attach(document.body);
    })
</script>


<script src="/js/script.js"></script>

  </body>
</html>