
<!DOCTYPE html>
<html>
    <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=0">
   <link rel="stylesheet" href="/assets/themes//css/bootstrap.min.css" media="screen and (min-device-width: 700px)"/>
   <link rel="stylesheet" href="/assets/themes//css/pygments.css" />
   <link rel="stylesheet" href="/assets/themes//css/style.css" media="screen"/>
   <link rel="stylesheet" href="/assets/themes//css/mobile.css" media="handheld"/>
   <script type="text/javascript" charset="utf-8" async="" src="/assets/themes//js/common.js"></script>

   <header>
       <meta charset="utf-8">
       <meta charset="UTF-8"/>
       
       
       <title>Kong源码分析: 启动 | Yukang's Page</title>
       

       
       <meta name="description" content="">
       
       <meta name="author" content="Yukang">

       <script type="text/javascript"
               href="/assets/themes/twitter/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
       </script>

       <!-- Le fav and touch icons -->
       <link rel="shortcut icon" href="/images/favicon.ico">
       <div class="navbar" id="navbar">
           <div class="navbar-inner">
        <div class="container">
          <a class="brand" id="brand" href="/">Yukang's Page</a>
          <ul class="nav" id="navbar-inner">
            
            
            


  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/archive">归档</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签</a></li>
      	
      
    
  




            <li class="divider-vertical"></li>
            <li><a href="/about.html">关于</a></li>
            <li><a href="/links.html">链接</a></li>
            <li><a href="/atom.xml">订阅</a></li>
          </ul>
          <span class="pull-right slogan"> Don't Panic </span>
        </div>
      </div>
    </div>
  </header>

  <body>
      <div class="container">
      <div class="content" >
        

<div class="row post">
    <div class="span8">
        <h1 class="title">Kong源码分析: 启动</h1>

            <h3>Kong的初始化过程</h3>

<p>安装好Kong之后我们是用命令<code>sudo ./bin/kong start -c kong.conf -vv</code>来启动。其中kong.conf为配置文件，<code>-vv</code>选项打印出一些重要信息展示出来，方便发现问题。</p>

<p>可以看到<code>./bin/kong</code>是一个脚本，是用的<code>#!/usr/local/openresty/bin/resty</code>程序来执行，而resty是OpenResty的一个perl可执行脚本。kong的内容很简单，就是一个入口函数调用： 
<code>require(&quot;kong.cmd.init&quot;)(arg)</code></p>

<p>所以我们可以从cmd/init.lua这个文件开始入手看启动过程。一翻开init.lua这个文件，发现其实不过是个wrapper，解析了args之后就是调用start，stop，quit等命令。然后我们顺藤摸瓜找cmd/start.lua文件，整个启动过程就在这里了：</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span></span>  <span class="kd">local</span> <span class="n">conf</span> <span class="o">=</span> <span class="nb">assert</span><span class="p">(</span><span class="n">conf_loader</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">conf</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">prefix</span>
  <span class="p">}))</span>

  <span class="kd">local</span> <span class="n">err</span>
  <span class="kd">local</span> <span class="n">dao</span> <span class="o">=</span> <span class="nb">assert</span><span class="p">(</span><span class="n">DAOFactory</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
  <span class="nb">xpcall</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
    <span class="nb">assert</span><span class="p">(</span><span class="n">prefix_handler</span><span class="p">.</span><span class="n">prepare_prefix</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">nginx_conf</span><span class="p">))</span>
    <span class="nb">assert</span><span class="p">(</span><span class="n">dao</span><span class="p">:</span><span class="n">run_migrations</span><span class="p">())</span>
    <span class="nb">assert</span><span class="p">(</span><span class="n">serf_signals</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">dao</span><span class="p">))</span>
    <span class="nb">assert</span><span class="p">(</span><span class="n">nginx_signals</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Kong started&quot;</span><span class="p">)</span>
  <span class="kr">end</span><span class="p">,</span> <span class="kr">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">e</span> <span class="c1">-- cannot throw from this function</span>
  <span class="kr">end</span><span class="p">)</span>  
</code></pre></div>
<p>从代码上来看很直观，首先conf_loader载入配置文件，DAOFactory构建数据库连接层，prefix_handler.prepare_prefix是准备一些由程序生成的配置文件。dao:run_migrations是可能有的启动时数据库改动。serf_signals是启动serf程序，nginx_signals是启动nginx进程。</p>

<h3>读取配置文件conf_loader</h3>

<p>conf_loader读取的当然是命令行里面传入的kong.conf文件，打开conf_loader.lua看了看，是是用一个lua第三方库来做文件解析的。<code>local pl_config = require &quot;pl.config&quot;</code>，最开始不太知道这个pl是什么，经过搜索后才知道是这里<a href="https://github.com/stevedonovan/Penlight/tree/master/lua/pl">定义的</a>，在kong.rockspec里面有定义了该库的依赖<code>&quot;penlight == 1.4.1&quot;</code>。读取配置的整个过程比较琐碎，最后回构建一个解析好的conf表。这里学到了Lua里面的setmetatable设置元表的方法，table作为Lua里面的最基本数据结构，setmetatable可以方便的绑定一个key和其对应的方法。看起来也像是面向对象的风格，在conf_loader的最后部分是:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span></span><span class="kr">return</span> <span class="nb">setmetatable</span><span class="p">({</span>
  <span class="nb">load</span> <span class="o">=</span> <span class="nb">load</span><span class="p">,</span>
  <span class="n">add_default_path</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">DEFAULT_PATHS</span><span class="p">[</span><span class="o">#</span><span class="n">DEFAULT_PATHS</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
  <span class="kr">end</span><span class="p">,</span>
  <span class="p">......</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="n">__call</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="p">...)</span>
    <span class="kr">return</span> <span class="nb">load</span><span class="p">(...)</span>
  <span class="kr">end</span>
<span class="p">})</span>
</code></pre></div>
<p>这样其他地方调用的时候<code>local conf, err, errors = conf_loader(args.conf)</code>自然就把args.conf传入load，返回解析后的结果。</p>

<h3>prepare_prefix动态生成Nginx和serf的配置</h3>

<p>prefix_handler.lua这个文件主要在准备一些Nginx的配置文件和serf的配置文件。prepare_prefix函数前半部分在创建各个子目录，logs、serf、pids、以及各个日志文件。关于Kong的config部分需要参考一下<a href="https://getkong.org/docs/0.10.x/configuration/">这里</a>。这个函数比较长，重要的部分是生成Nginx的配置文件。
可以看到compile_kong_conf函数其实是是用kong/templates目录下的nginx_kong.lua和nginx.lua分别生成两个文件，其中nginx_kong.lua里面包含了嵌入Kong的Lua代码的逻辑。</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span></span><span class="n">init_by_lua_block</span> <span class="p">{</span>
    <span class="nb">require</span> <span class="s1">&#39;luarocks.loader&#39;</span>
    <span class="nb">require</span> <span class="s1">&#39;resty.core&#39;</span>
    <span class="n">kong</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;kong&#39;</span>
    <span class="n">kong</span><span class="p">.</span><span class="n">init</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">location</span> <span class="o">/</span> <span class="p">{</span> 
  <span class="n">rewrite_by_lua_block</span> <span class="p">{</span>
      <span class="n">kong</span><span class="p">.</span><span class="n">rewrite</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="n">access_by_lua_block</span> <span class="p">{</span>
      <span class="n">kong</span><span class="p">.</span><span class="n">access</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="n">header_filter_by_lua_block</span> <span class="p">{</span>
      <span class="n">kong</span><span class="p">.</span><span class="n">header_filter</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="n">body_filter_by_lua_block</span> <span class="p">{</span>
      <span class="n">kong</span><span class="p">.</span><span class="n">body_filter</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="n">log_by_lua_block</span> <span class="p">{</span>
      <span class="n">kong</span><span class="p">.</span><span class="n">log</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>因此我们可以知道Kong每次reload或者启动的时候会生成新的Nginx配置文件，所以我们如果要加入自己的配置可以直接修改nginx_kong.lua文件。另外我在使用的时候发现一个小问题，Kong把serf的node_id存在一个文件里，如果我们把之前跑过Kong的机器做了镜像，然后再启动一个新的实例时，这个node_id文件既然存在则没有重新生成，最终导致两台kong实例并没有相互通信形成一个集群。我认为这里其实可以再检查一下node_id的文件和本机的ip是否一致，如果不一致则重新生成。</p>

<h3>dao:run_migrations()</h3>

<p>初始化过程的下一步则是执行数据库操作，Kong目前只支持cassandra和Postgres，个人认为应该增加Redis的支持。</p>

<h3>serf_signals.start</h3>

<p>之前提到过serf是用来保证kong instance之间的通信的，启动的时候的一个很重要参数是<code>--event-handler</code>，参数的内容是一个可执行脚本(通常叫做serf_event.sh)，文件的内容是前面生成配置文件的时候写入的。默认情况下serf会监听在7946端口，如果多台server需要形成一个集群，这个端口之间需要能相互通信。这里就有一个问题，在一个新的server刚启动的时候，该server是如何发现其他节点的呢？我们可以看到serf_signals.lua里的start函数调用了serf:autojoin()函数，跟踪到autojoin里面看代码，其实是从数据库里读取出其他nodes的信息，然后依次告诉对方新同志加入了，然后把自己的节点信息写入到数据库里。自然如果要退出也需要把自己的信息从数据库里删掉。</p>

<h3>nginx_signals.start</h3>

<p>启动的最后一步即是Nginx的启动，其实最终执行的命令就是:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>/usr/local/openresty/nginx/sbin/nginx -p /usr/local/kong -c nginx.conf
</code></pre></div>
<h3>总结</h3>

<p>通过上面的分析，可以总结Kong的启动过程即是：解析输入参数，验证参数合法性并生成必要的目录和配置文件，执行数据库操作，启动serf，启动Nginx。最终其实就是一个OpenResty启动过程，嵌入Kong里面的core部分的Lua代码。后面继续分析其可扩展的插件机制。</p>

            
            <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">          
                <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
                    <span>打赏</span>
                </button>
                <div id="QR" style="display: none;">      
                    <div id="wechat" style="display: inline-block">
                        <a href="/images/yukang_wechat.jpg" rel="group" ><img id="wechat_qr" src="/images/yukang_wechat.jpg" style="width: 255px;height:235px;"  alt="Yukang WeChat Pay"></a>
                    </div>
                </div>
            </div>
            
            <ul class="pager" id="page-nav">
                
                <li class="next"><a href="/2017/07/02/kong-intro.html" title="Kong源码分析">Kong源码分析&rarr;</a></li>
                

                
                <li class="previous"><a href="/2017/07/16/kong-intro-3.html" title="Kong源码分析: 插件">&larr; Kong源码分析: 插件</a></li>
                
            </ul>

            <!--*********************************************************-->
            <!--****** 看见这个时候，删掉下面的统计代码啊~ ******-->
            <!--*********************************************************-->
            <div id="disqus_thread"></div>
            <script>

            /**
            *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
            *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
            /*
            var disqus_config = function () {
            this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
            };
            */
            (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://yukang.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
            })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>


        <div class="span4 sidebar">
            
            <h4 class="date">日期：<span>07 July 2017</span></h4>
            

            

            <div class="violet-aside-post">
                <h4 class="v-section-tit">最近</h4>
                <ul>
                    
                    <li class="v-aside-li">
                        <a href="/2017/07/22/kong-intro-5.html" title="Kong源码分析: 事件" rel="bookmark">Kong源码分析: 事件</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/07/22/kong-intro-4.html" title="Kong源码分析: 缓存" rel="bookmark">Kong源码分析: 缓存</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/07/16/kong-intro-3.html" title="Kong源码分析: 插件" rel="bookmark">Kong源码分析: 插件</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/07/07/kong-intro-2.html" title="Kong源码分析: 启动" rel="bookmark">Kong源码分析: 启动</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/07/02/kong-intro.html" title="Kong源码分析" rel="bookmark">Kong源码分析</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/06/27/recent-reading-list.html" title="小说推荐" rel="bookmark">小说推荐</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/05/22/try-on-openresty.html" title="OpenResty使用总结" rel="bookmark">OpenResty使用总结</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/04/09/rubytt-cont.html" title="rubytt 续" rel="bookmark">rubytt 续</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/01/24/disease-of-programmer.html" title="程序员病" rel="bookmark">程序员病</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2016/12/27/rubytt.html" title="Ruby 程序的静态分析: rubytt" rel="bookmark">Ruby 程序的静态分析: rubytt</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2016/12/11/qianlong-history.html" title="读《饥饿的盛世》" rel="bookmark">读《饥饿的盛世》</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2016/11/30/nginx-traffic-limit.html" title="Nginx限流" rel="bookmark">Nginx限流</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2016/08/09/dao-yu-ju.html" title="菊与刀" rel="bookmark">菊与刀</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2016/07/22/capistrano-syntax-check-for-rails.html" title="Add syntax check for Capistrano" rel="bookmark">Add syntax check for Capistrano</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2016/07/08/fun-on-hackerrank.html" title="刷刷算法和 OJ" rel="bookmark">刷刷算法和 OJ</a>
                    </li>
                    
                </ul>
            </div>

            <div class="violet-aside-post">
                <h4 class="v-section-tit">页面</h4>
                <nav class="nav">
                    <ul>
                        <li><a href="/archive.html" >归档</a></li>
                        <li><a href="/tags.html">标签</a></li>
                        <li><a href="/links.html" >链接</a></li>
                        <li><a href="/about.html" >关于</a></li>
                        <li><a href="/atom.xml" target="_blank" >RSS</a></li>
                    </ul>
                </nav>
            </div>
        </div>
</div>




      </div>

      <footer id="footer">
        <p>&copy; <a href="mailto:moorekang@gmail.com">Yukang</a> 2016.
          Proudly powered by <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll</a>
        </p>

      </footer>
    </div> <!-- /container -->

    <!--*********************************************************-->
    <!--****** 看见这个时候，删掉下面的统计代码啊~ ******-->
    <!--*********************************************************-->
    
    <script>
     var _hmt = _hmt || [];
     (function() {
         var hm = document.createElement("script");
         hm.src = "//hm.baidu.com/hm.js?ba1315646a61cc7bd6f574a6b5221640";
         var s = document.getElementsByTagName("script")[0]; 
         s.parentNode.insertBefore(hm, s);
     })();

     (function() {
         var width = document.body.offsetWidth;
         if(width < 701) {
             var nav = document.getElementById("navbar-inner");
             nav.remove();
         };
     })();
    </script>

    <!--*********************************************************-->

  </body>
  
</html>

