
<!DOCTYPE html>
<html>
    <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=0">
   <link rel="stylesheet" href="/assets/themes//css/bootstrap.min.css" media="screen and (min-device-width: 700px)"/>
   <link rel="stylesheet" href="/assets/themes//css/pygments.css" />
   <link rel="stylesheet" href="/assets/themes//css/style.css" media="screen"/>
   <link rel="stylesheet" href="/assets/themes//css/mobile.css" media="handheld"/>
   <script type="text/javascript" charset="utf-8" async="" src="/assets/themes//js/common.js"></script>

   <header>
       <meta charset="utf-8">
       <meta charset="UTF-8"/>
       
       
       <title>Kong源码分析: 缓存 | Yukang's Page</title>
       

       
       <meta name="description" content="">
       
       <meta name="author" content="Yukang">

       <script type="text/javascript"
               href="/assets/themes/twitter/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
       </script>

       <!-- Le fav and touch icons -->
       <link rel="shortcut icon" href="/images/favicon.ico">
       <div class="navbar" id="navbar">
           <div class="navbar-inner">
        <div class="container">
          <a class="brand" id="brand" href="/">Yukang's Page</a>
          <ul class="nav" id="navbar-inner">
            
            
            


  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/archive">归档</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签</a></li>
      	
      
    
  




            <li class="divider-vertical"></li>
            <li><a href="/about.html">关于</a></li>
            <li><a href="/links.html">链接</a></li>
            <li><a href="/atom.xml">订阅</a></li>
          </ul>
          <span class="pull-right slogan"> Don't Panic </span>
        </div>
      </div>
    </div>
  </header>

  <body>
      <div class="container">
      <div class="content" >
        

<div class="row post">
    <div class="span8">
        <h1 class="title">Kong源码分析: 缓存</h1>

            <h3>Nginx里的缓存使用</h3>

<p>在Kong里面我们缓存的内容大部分是配置，不管是API本身的配置还是插件相关的配置，缓存之后就存储在内存中。</p>

<p>Kong里的缓存基础代码在tools/database_cache.lua文件里面。这里又分两种类型的缓存，一种是<a href="https://github.com/openresty/lua-nginx-module#ngxshareddict">shared dict</a>, 一种是使用
<a href="https://github.com/openresty/lua-resty-lrucache">lua-resty-lrucache</a>。这两者之间是有区别的: shared dict如同其名字一样是Nginx worker之间共享的，而lrucache是worker级别的，内存空间在Lua VM里由GC管理，不能在进程之间共享，自然也不会在Nginx worker之间共享。</p>

<p>具体我们开发中使用哪一种由具体场景分析，比如在Kong的插件rate-limiting里就使用了共享缓存，因为我们需要针对一个Nginx所有的worker做请求数统计。</p>

<p>share dict最常规的使用方法是:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span></span> <span class="n">http</span> <span class="p">{</span>
     <span class="n">lua_shared_dict</span> <span class="n">dogs</span> <span class="mi">10</span><span class="n">m</span><span class="p">;</span>
     <span class="n">server</span> <span class="p">{</span>
         <span class="n">location</span> <span class="o">/</span><span class="n">set</span> <span class="p">{</span>
             <span class="n">content_by_lua_block</span> <span class="p">{</span>
                 <span class="kd">local</span> <span class="n">dogs</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">dogs</span>
                 <span class="n">dogs</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Jim&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
                 <span class="n">ngx</span><span class="p">.</span><span class="n">say</span><span class="p">(</span><span class="s2">&quot;STORED&quot;</span><span class="p">)</span>
             <span class="p">}</span>
         <span class="p">}</span>
         <span class="n">location</span> <span class="o">/</span><span class="n">get</span> <span class="p">{</span>
             <span class="n">content_by_lua_block</span> <span class="p">{</span>
                 <span class="kd">local</span> <span class="n">dogs</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">dogs</span>
                 <span class="n">ngx</span><span class="p">.</span><span class="n">say</span><span class="p">(</span><span class="n">dogs</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Jim&quot;</span><span class="p">))</span>
             <span class="p">}</span>
         <span class="p">}</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>
<p>lrucache的使用方法如<a href="https://github.com/openresty/lua-resty-lrucache">文档所示</a>。</p>

<h3>Kong里的多级缓存实现</h3>

<p>有了上面的了解，看database_cache.lua这个文件就比较直观了，这里Kong会分多类缓存: apis, consumers, plugins等。具体这样分是因为如果我们对配置做了修改，需要发出serf消息来指名这次改动涉及到哪些，其他Kong节点收到消息后自然只更新对应的缓存部分。所以Kong里申明了一个列表CACHE_KEYS来存要缓存的数据类别，同时写了不少生成缓存key的方法，比如: api_key，plugin_key等。</p>

<p>仔细查看database_cache.lua，我们发现其实这里是做了两级缓存。Kong要从缓存里取出一个key/value，首先从lrucache里取，如果有则返回。如果没有则从share dict里去取，如果取到则deserialize然后存储在lrucache里，然后返回。如果shared dict里也没有，则返回nil。标准的两级缓存流程，这样做的好处在于减少deserialize的次数，而且shared dict可能被多个worker同时修改，要修改的时候需要加互斥锁。</p>

<p>这里最常用的方法是get_or_set，尝试获取一个key的值，如果没有就执行对应的callback，返回结果当做value设置到缓存里，并把value作为最后的返回结果。这里的callback函数通常做的当然是从数据库里读取内容。</p>

<h3>如何避免缓存失效风暴</h3>

<p>我们在实现缓存的时候<a href="http://www.sobstel.org/blog/preventing-dogpile-effect/">缓存失效风暴问题</a>需要谨慎考虑。agentzh在这里详细描述了<a href="https://github.com/openresty/lua-resty-lock">加锁解决的策略</a>，<a href="https://github.com/mtourne/ngx.shcache">ngx.shcache</a>这里也使用了相同的方法，具体可以好好研究一下那个图。</p>

<p>主要注意的是在加锁后，再尝试去读取一次key，因为可能在加锁之前其他worker刚好把数据更新到了缓存里。</p>

            
            <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">          
                <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
                    <span>打赏</span>
                </button>
                <div id="QR" style="display: none;">      
                    <div id="wechat" style="display: inline-block">
                        <a href="/images/yukang_wechat.jpg" rel="group" ><img id="wechat_qr" src="/images/yukang_wechat.jpg" style="width: 255px;height:235px;"  alt="Yukang WeChat Pay"></a>
                    </div>
                </div>
            </div>
            
            <ul class="pager" id="page-nav">
                
                <li class="next"><a href="/2017/07/16/kong-intro-3.html" title="Kong源码分析: 插件">Kong源码分析: 插件&rarr;</a></li>
                

                
                <li class="previous"><a href="/2017/07/22/kong-intro-5.html" title="Kong源码分析: 事件">&larr; Kong源码分析: 事件</a></li>
                
            </ul>

            <!--*********************************************************-->
            <!--****** 看见这个时候，删掉下面的统计代码啊~ ******-->
            <!--*********************************************************-->
            <div id="disqus_thread"></div>
            <script>

            /**
            *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
            *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
            /*
            var disqus_config = function () {
            this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
            };
            */
            (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://yukang.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
            })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>


        <div class="span4 sidebar">
            
            <h4 class="date">日期：<span>22 July 2017</span></h4>
            

            

            <div class="violet-aside-post">
                <h4 class="v-section-tit">最近</h4>
                <ul>
                    
                    <li class="v-aside-li">
                        <a href="/2017/07/22/kong-intro-5.html" title="Kong源码分析: 事件" rel="bookmark">Kong源码分析: 事件</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/07/22/kong-intro-4.html" title="Kong源码分析: 缓存" rel="bookmark">Kong源码分析: 缓存</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/07/16/kong-intro-3.html" title="Kong源码分析: 插件" rel="bookmark">Kong源码分析: 插件</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/07/07/kong-intro-2.html" title="Kong源码分析: 启动" rel="bookmark">Kong源码分析: 启动</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/07/02/kong-intro.html" title="Kong源码分析" rel="bookmark">Kong源码分析</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/06/27/recent-reading-list.html" title="小说推荐" rel="bookmark">小说推荐</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/05/22/try-on-openresty.html" title="OpenResty使用总结" rel="bookmark">OpenResty使用总结</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/04/09/rubytt-cont.html" title="rubytt 续" rel="bookmark">rubytt 续</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2017/01/24/disease-of-programmer.html" title="程序员病" rel="bookmark">程序员病</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2016/12/27/rubytt.html" title="Ruby 程序的静态分析: rubytt" rel="bookmark">Ruby 程序的静态分析: rubytt</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2016/12/11/qianlong-history.html" title="读《饥饿的盛世》" rel="bookmark">读《饥饿的盛世》</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2016/11/30/nginx-traffic-limit.html" title="Nginx限流" rel="bookmark">Nginx限流</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2016/08/09/dao-yu-ju.html" title="菊与刀" rel="bookmark">菊与刀</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2016/07/22/capistrano-syntax-check-for-rails.html" title="Add syntax check for Capistrano" rel="bookmark">Add syntax check for Capistrano</a>
                    </li>
                    
                    <li class="v-aside-li">
                        <a href="/2016/07/08/fun-on-hackerrank.html" title="刷刷算法和 OJ" rel="bookmark">刷刷算法和 OJ</a>
                    </li>
                    
                </ul>
            </div>

            <div class="violet-aside-post">
                <h4 class="v-section-tit">页面</h4>
                <nav class="nav">
                    <ul>
                        <li><a href="/archive.html" >归档</a></li>
                        <li><a href="/tags.html">标签</a></li>
                        <li><a href="/links.html" >链接</a></li>
                        <li><a href="/about.html" >关于</a></li>
                        <li><a href="/atom.xml" target="_blank" >RSS</a></li>
                    </ul>
                </nav>
            </div>
        </div>
</div>




      </div>

      <footer id="footer">
        <p>&copy; <a href="mailto:moorekang@gmail.com">Yukang</a> 2016.
          Proudly powered by <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll</a>
        </p>

      </footer>
    </div> <!-- /container -->

    <!--*********************************************************-->
    <!--****** 看见这个时候，删掉下面的统计代码啊~ ******-->
    <!--*********************************************************-->
    
    <script>
     var _hmt = _hmt || [];
     (function() {
         var hm = document.createElement("script");
         hm.src = "//hm.baidu.com/hm.js?ba1315646a61cc7bd6f574a6b5221640";
         var s = document.getElementsByTagName("script")[0]; 
         s.parentNode.insertBefore(hm, s);
     })();

     (function() {
         var width = document.body.offsetWidth;
         if(width < 701) {
             var nav = document.getElementById("navbar-inner");
             nav.remove();
         };
     })();
    </script>

    <!--*********************************************************-->

  </body>
  
</html>

